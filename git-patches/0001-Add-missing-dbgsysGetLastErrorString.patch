From 003fb9005ab99e6934cc1a9242037fc6b4428c85 Mon Sep 17 00:00:00 2001
From: Viktor Dukhovni <viktor@twosigma.com>
Date: Tue, 10 Nov 2015 21:32:45 +0000
Subject: [PATCH 01/24] Add missing dbgsysGetLastErrorString()

---
 .../share/native/libjdwp/export/sys.h         |  1 +
 .../unix/native/libjdwp/linker_md.c           | 22 +++++++++++++++++++
 2 files changed, 23 insertions(+)

diff --git a/src/jdk.jdwp.agent/share/native/libjdwp/export/sys.h b/src/jdk.jdwp.agent/share/native/libjdwp/export/sys.h
index 9561112457..1caae50c67 100644
--- a/src/jdk.jdwp.agent/share/native/libjdwp/export/sys.h
+++ b/src/jdk.jdwp.agent/share/native/libjdwp/export/sys.h
@@ -41,6 +41,7 @@ void    dbgsysBuildLibName(char *, int, const char *, const char *);
 void *  dbgsysLoadLibrary(const char *, char *err_buf, int err_buflen);
 void    dbgsysUnloadLibrary(void *);
 void *  dbgsysFindLibraryEntry(void *, const char *);
+int     dbgsysGetLastErrorString(char *, int);
 
 /* Implemented in exec_md.c */
 int     dbgsysExec(char *cmdLine);
diff --git a/src/jdk.jdwp.agent/unix/native/libjdwp/linker_md.c b/src/jdk.jdwp.agent/unix/native/libjdwp/linker_md.c
index 35b2814d5a..7703e30cf3 100644
--- a/src/jdk.jdwp.agent/unix/native/libjdwp/linker_md.c
+++ b/src/jdk.jdwp.agent/unix/native/libjdwp/linker_md.c
@@ -66,6 +66,28 @@ static void dll_build_name(char* buffer, size_t buflen,
     free(paths_copy);
 }
 
+int
+dbgsysGetLastErrorString(char *buf, int len)
+{
+    const char *s = dlerror();
+    size_t n;
+    size_t l = (size_t)len;
+
+    if (len <= 0)
+        return 0;
+
+    *buf = '\0';
+    if (s == NULL)
+        return 0;
+
+    n = strlen(s);
+    if (n >= l)
+        n = l - 1;
+    strncpy(buf, s, n);
+    buf[n] = '\0'; /* not actually needed */
+    return n;
+}
+
 /*
  * create a string for the JNI native function name by adding the
  * appropriate decorations.
-- 
2.17.1

