From 5ce0cf02baf3cf284fa5f87d9f5062134b004ddc Mon Sep 17 00:00:00 2001
From: Nico Williams <nico@twosigma.com>
Date: Fri, 4 Dec 2015 23:14:17 +0000
Subject: [PATCH 12/24] Add isDefaultCredential() method to GSSCredentialSpi

---
 .../security/jgss/krb5/Krb5AcceptCredential.java  | 12 ++++++++++++
 .../security/jgss/krb5/Krb5InitCredential.java    | 15 ++++++++++++++-
 .../sun/security/jgss/krb5/Krb5NameElement.java   |  4 ++++
 .../security/jgss/krb5/Krb5ProxyCredential.java   |  5 +++++
 .../sun/security/jgss/spi/GSSCredentialSpi.java   |  7 +++++++
 .../classes/sun/security/jgss/spi/GSSNameSpi.java |  6 ++++++
 .../security/jgss/spnego/SpNegoCredElement.java   |  4 ++++
 .../sun/security/jgss/wrapper/GSSCredElement.java |  8 ++++++++
 .../sun/security/jgss/wrapper/GSSNameElement.java |  4 ++++
 9 files changed, 64 insertions(+), 1 deletion(-)

diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java
index 262debcaf4..13e5b24f19 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java
@@ -47,6 +47,7 @@ public class Krb5AcceptCredential
 
     private final Krb5NameElement name;
     private final ServiceCreds screds;
+    private boolean isDefCred = false;
 
     private Krb5AcceptCredential(Krb5NameElement name, ServiceCreds creds) {
         /*
@@ -57,6 +58,8 @@ public class Krb5AcceptCredential
 
         this.name = name;
         this.screds = creds;
+        if (name == null)
+            isDefCred = true;
     }
 
     static Krb5AcceptCredential getInstance(final GSSCaller caller, Krb5NameElement name)
@@ -148,6 +151,15 @@ public class Krb5AcceptCredential
         return Krb5MechFactory.GSS_KRB5_MECH_OID;
     }
 
+    /**
+     * Returns true if the credential is a default credential.
+     *
+     * @return true if the credential is a default credential, else false.
+     */
+    public boolean isDefaultCredential() {
+        return isDefCred;
+    }
+
     public final java.security.Provider getProvider() {
         return Krb5MechFactory.PROVIDER;
     }
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java
index 3a692a2033..b69f51dbbf 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java
@@ -56,6 +56,7 @@ public class Krb5InitCredential
     private Krb5NameElement name;
     private Credentials krb5Credentials;
     public KerberosTicket proxyTicket;
+    private boolean isDefCred;
 
     private Krb5InitCredential(Krb5NameElement name,
                                byte[] asn1Encoding,
@@ -88,6 +89,8 @@ public class Krb5InitCredential
         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
                 .kerberosTicketSetServerAlias(this, serverAlias);
         this.name = name;
+        if (name == null)
+            isDefCred = true;
 
         try {
             // Cache this for later use by the sun.security.krb5 package.
@@ -149,7 +152,8 @@ public class Krb5InitCredential
                 .kerberosTicketSetServerAlias(this, serverAlias);
         this.name = name;
         // A delegated cred does not have all fields set. So do not try to
-        // creat new Credentials out of the delegatedCred.
+        // creat new Credentials out of the delegatedCred.  Also, a delegated
+        // credential is not a default credential.
         this.krb5Credentials = delegatedCred;
     }
 
@@ -311,6 +315,15 @@ public class Krb5InitCredential
         return Krb5MechFactory.GSS_KRB5_MECH_OID;
     }
 
+    /**
+     * Returns true if the credential is a default credential.
+     *
+     * @return true if the credential is a default credential, else false.
+     */
+    public boolean isDefaultCredential() {
+        return isDefCred;
+    }
+
     public final java.security.Provider getProvider() {
         return Krb5MechFactory.PROVIDER;
     }
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java
index d6bb727e4a..6a5a439008 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java
@@ -367,6 +367,10 @@ public class Krb5NameElement
         return (gssNameType.equals(GSSName.NT_ANONYMOUS));
     }
 
+    public boolean isDefaultCredentialName() {
+        return false;
+    }
+
     public Provider getProvider() {
         return Krb5MechFactory.PROVIDER;
     }
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5ProxyCredential.java b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5ProxyCredential.java
index 8fbe93a576..2d1d600cd2 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5ProxyCredential.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5ProxyCredential.java
@@ -91,6 +91,11 @@ public class Krb5ProxyCredential
         return false;
     }
 
+    @Override
+    public final boolean isDefaultCredential() {
+        return false;
+    }
+
     @Override
     public final Oid getMechanism() {
         return Krb5MechFactory.GSS_KRB5_MECH_OID;
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSCredentialSpi.java b/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSCredentialSpi.java
index 69646d7a96..c417c9999b 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSCredentialSpi.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSCredentialSpi.java
@@ -88,6 +88,13 @@ public interface GSSCredentialSpi {
      */
     public boolean isAcceptorCredential() throws GSSException;
 
+     /**
+      * Returns true if the credential is a default credential.
+      *
+      * @return true if the credential is a default credential, else false.
+      */
+     public boolean isDefaultCredential();
+
     /**
      * Returns the oid representing the underlying credential
      * mechanism oid.
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSNameSpi.java b/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSNameSpi.java
index bfb93f9371..ed4af83000 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSNameSpi.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/spi/GSSNameSpi.java
@@ -129,4 +129,10 @@ public interface GSSNameSpi {
      * Indicates if this name object represents an Anonymous name.
      */
     public boolean isAnonymousName();
+
+    /**
+     * Indicates whether this name object refers to whatever name(s) the
+     * default credentials respond to.
+     */
+    public boolean isDefaultCredentialName();
 }
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/spnego/SpNegoCredElement.java b/src/java.security.jgss/share/classes/sun/security/jgss/spnego/SpNegoCredElement.java
index c7cf947742..a832fcc307 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/spnego/SpNegoCredElement.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/spnego/SpNegoCredElement.java
@@ -91,4 +91,8 @@ public class SpNegoCredElement implements GSSCredentialSpi {
     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
         return cred.impersonate(name);
     }
+
+    public boolean isDefaultCredential() {
+        return cred.isDefaultCredential();
+    }
 }
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSCredElement.java b/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSCredElement.java
index d457baf6e5..5d2b7e6486 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSCredElement.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSCredElement.java
@@ -42,6 +42,7 @@ public class GSSCredElement implements GSSCredentialSpi {
     long pCred; // Pointer to the gss_cred_id_t structure
     private GSSNameElement name = null;
     private GSSLibStub cStub;
+    public boolean isDefCred;
 
     // Perform the necessary ServicePermission check on this cred
     void doServicePermCheck() throws GSSException {
@@ -79,10 +80,13 @@ public class GSSCredElement implements GSSCredentialSpi {
             doServicePermCheck();
             pCred = cStub.acquireCred(this.name.pName, password, lifetime,
                     usage);
+            if (name == GSSNameElement.DEF_ACCEPTOR)
+                isDefCred = true;
         } else {
             pCred = cStub.acquireCred(0, password, lifetime, usage);
             this.name = new GSSNameElement(cStub.getCredName(pCred), cStub.getMech(), cStub);
             doServicePermCheck();
+            isDefCred = true;
         }
     }
 
@@ -131,6 +135,10 @@ public class GSSCredElement implements GSSCredentialSpi {
         return cStub.getMech();
     }
 
+    public boolean isDefaultCredential() {
+        return isDefCred;
+    }
+
     public String toString() {
         // No hex bytes available for native impl
         return "N/A";
diff --git a/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSNameElement.java b/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSNameElement.java
index 9952ee12d1..d066de5e96 100644
--- a/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSNameElement.java
+++ b/src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSNameElement.java
@@ -294,6 +294,10 @@ public class GSSNameElement implements GSSNameSpi {
         return (GSSName.NT_ANONYMOUS.equals(printableType));
     }
 
+    public boolean isDefaultCredentialName() {
+        return (this == DEF_ACCEPTOR);
+    }
+
     public void dispose() {
         if (pName != 0) {
             cStub.releaseName(pName);
-- 
2.17.1

