<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Sdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5MechFactory.java</title>
</head><body id="SUNWwebrev">
<a class="print" href="javascript:print()">Print this page</a>
<pre>Add JGSS JNI bindings for gss cred store functions
Add createCredential() with password
Also avoid memory allocation in newGSSOIDSet() renamed to makeGSSOIDset()
which now takes a singleton set argument and either assigns the requested
OID or with SPNEGO returns a static list of all the supported mechs. With
this we no longer need deleteGSSOIDSet().</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.krb5;
  27 
  28 import org.ietf.jgss.*;
  29 import sun.security.jgss.GSSUtil;
  30 import sun.security.jgss.GSSCaller;
  31 import sun.security.jgss.spi.*;
  32 import javax.security.auth.kerberos.ServicePermission;
  33 import java.security.Provider;
  34 import java.util.Vector;

  35 
  36 /**
  37  * Krb5 Mechanism plug in for JGSS
  38  * This is the properties object required by the JGSS framework.
  39  * All mechanism specific information is defined here.
  40  *
  41  * @author Mayank Upadhyay
  42  */
  43 
  44 public final class Krb5MechFactory implements MechanismFactory {
  45 
  46     private static final boolean DEBUG = Krb5Util.DEBUG;
  47 
  48     static final Provider PROVIDER =
  49         new sun.security.jgss.SunProvider();
  50 
  51     static final Oid GSS_KRB5_MECH_OID =
  52         createOid("1.2.840.113554.1.2.2");
  53 
  54     static final Oid NT_GSS_KRB5_PRINCIPAL =

</pre><hr></hr><pre>
  91     }
  92 
  93     public Krb5MechFactory(GSSCaller caller) {
  94         this.caller = caller;
  95     }
  96 
  97     public GSSNameSpi getNameElement(String nameStr, Oid nameType)
  98         throws GSSException {
  99         return Krb5NameElement.getInstance(nameStr, nameType);
 100     }
 101 
 102     public GSSNameSpi getNameElement(byte[] name, Oid nameType)
 103         throws GSSException {
 104         // At this point, even an exported name is stripped down to safe
 105         // bytes only
 106         // XXX Use encoding here
 107         return Krb5NameElement.getInstance(new String(name), nameType);
 108     }
 109 
 110     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,
<span class="changed"> 111            int initLifetime, int acceptLifetime,</span>
 112            int usage) throws GSSException {
 113 








 114         if (name != null &amp;&amp; !(name instanceof Krb5NameElement)) {
 115             name = Krb5NameElement.getInstance(name.toString(),
 116                                        name.getStringNameType());
 117         }
 118 
 119         Krb5CredElement credElement = getCredFromSubject
 120             (name, (usage != GSSCredential.ACCEPT_ONLY));
 121 
 122         if (credElement == null) {
 123             if (usage == GSSCredential.INITIATE_ONLY ||
 124                 usage == GSSCredential.INITIATE_AND_ACCEPT) {
 125                 credElement = Krb5InitCredential.getInstance
 126                     (caller, (Krb5NameElement) name, initLifetime);
 127                 credElement = Krb5ProxyCredential.tryImpersonation(
 128                         caller, (Krb5InitCredential)credElement);
 129                 checkInitCredPermission
 130                     ((Krb5NameElement) credElement.getName());
 131             } else if (usage == GSSCredential.ACCEPT_ONLY) {
 132                 credElement =
 133                     Krb5AcceptCredential.getInstance(caller,
 134                                                      (Krb5NameElement) name);
 135                 checkAcceptCredPermission
 136                     ((Krb5NameElement) credElement.getName(), name);
 137             } else
 138                 throw new GSSException(GSSException.FAILURE, -1,
 139                                        "Unknown usage mode requested");
 140         }
 141         return credElement;
 142     }
 143 
























































 144     public static void checkInitCredPermission(Krb5NameElement name) {
 145         SecurityManager sm = System.getSecurityManager();
 146         if (sm != null) {
 147             String realm = (name.getKrb5PrincipalName()).getRealmAsString();
 148             String tgsPrincipal =
 149                 new String("krbtgt/" + realm + '@' + realm);
 150             ServicePermission perm =
 151                 new ServicePermission(tgsPrincipal, "initiate");
 152             try {
 153                 sm.checkPermission(perm);
 154             } catch (SecurityException e) {
 155                 if (DEBUG) {
<span class="changed"> 156                     System.out.println("Permission to initiate" +</span>
 157                         "kerberos init credential" + e.getMessage());
 158                 }
 159                 throw e;
 160             }
 161         }
 162     }
 163 
 164     public static void checkAcceptCredPermission(Krb5NameElement name,
 165                                            GSSNameSpi originalName) {
 166         SecurityManager sm = System.getSecurityManager();
 167         if (sm != null &amp;&amp; name != null) {
 168             ServicePermission perm = new ServicePermission
 169                 (name.getKrb5PrincipalName().getName(), "accept");
 170             try {
 171                 sm.checkPermission(perm);
 172             } catch (SecurityException e) {
 173                 if (originalName == null) {
 174                     // Don't disclose the name of the principal
 175                     e = new SecurityException("No permission to acquire "
 176                                       + "Kerberos accept credential");

</pre><hr></hr>
</pre></td><td><pre>

</pre><hr></hr><pre>
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.krb5;
  27 
  28 import org.ietf.jgss.*;
  29 import sun.security.jgss.GSSUtil;
  30 import sun.security.jgss.GSSCaller;
  31 import sun.security.jgss.spi.*;
  32 import javax.security.auth.kerberos.ServicePermission;
  33 import java.security.Provider;
  34 import java.util.Vector;
<span class="new">  35 import java.util.Map;</span>
  36 
  37 /**
  38  * Krb5 Mechanism plug in for JGSS
  39  * This is the properties object required by the JGSS framework.
  40  * All mechanism specific information is defined here.
  41  *
  42  * @author Mayank Upadhyay
  43  */
  44 
  45 public final class Krb5MechFactory implements MechanismFactory {
  46 
  47     private static final boolean DEBUG = Krb5Util.DEBUG;
  48 
  49     static final Provider PROVIDER =
  50         new sun.security.jgss.SunProvider();
  51 
  52     static final Oid GSS_KRB5_MECH_OID =
  53         createOid("1.2.840.113554.1.2.2");
  54 
  55     static final Oid NT_GSS_KRB5_PRINCIPAL =

</pre><hr></hr><pre>
  92     }
  93 
  94     public Krb5MechFactory(GSSCaller caller) {
  95         this.caller = caller;
  96     }
  97 
  98     public GSSNameSpi getNameElement(String nameStr, Oid nameType)
  99         throws GSSException {
 100         return Krb5NameElement.getInstance(nameStr, nameType);
 101     }
 102 
 103     public GSSNameSpi getNameElement(byte[] name, Oid nameType)
 104         throws GSSException {
 105         // At this point, even an exported name is stripped down to safe
 106         // bytes only
 107         // XXX Use encoding here
 108         return Krb5NameElement.getInstance(new String(name), nameType);
 109     }
 110 
 111     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,
<span class="changed"> 112            String password, int initLifetime, int acceptLifetime,</span>
 113            int usage) throws GSSException {
 114 
<span class="new"> 115         if (password != null) {</span>
<span class="new"> 116             // XXX Implement!  Shouldn't be too hard...</span>
<span class="new"> 117             throw new GSSException(GSSException.UNAVAILABLE, -1,</span>
<span class="new"> 118                     "The Kerberos mechanism Java implementation does not " +</span>
<span class="new"> 119                     "currently support acquiring GSS credentials handle " +</span>
<span class="new"> 120                     "elements with a password");</span>
<span class="new"> 121         }</span>
<span class="new"> 122 </span>
 123         if (name != null &amp;&amp; !(name instanceof Krb5NameElement)) {
 124             name = Krb5NameElement.getInstance(name.toString(),
 125                                        name.getStringNameType());
 126         }
 127 
 128         Krb5CredElement credElement = getCredFromSubject
 129             (name, (usage != GSSCredential.ACCEPT_ONLY));
 130 
 131         if (credElement == null) {
 132             if (usage == GSSCredential.INITIATE_ONLY ||
 133                 usage == GSSCredential.INITIATE_AND_ACCEPT) {
 134                 credElement = Krb5InitCredential.getInstance
 135                     (caller, (Krb5NameElement) name, initLifetime);
 136                 credElement = Krb5ProxyCredential.tryImpersonation(
 137                         caller, (Krb5InitCredential)credElement);
 138                 checkInitCredPermission
 139                     ((Krb5NameElement) credElement.getName());
 140             } else if (usage == GSSCredential.ACCEPT_ONLY) {
 141                 credElement =
 142                     Krb5AcceptCredential.getInstance(caller,
 143                                                      (Krb5NameElement) name);
 144                 checkAcceptCredPermission
 145                     ((Krb5NameElement) credElement.getName(), name);
 146             } else
 147                 throw new GSSException(GSSException.FAILURE, -1,
 148                                        "Unknown usage mode requested");
 149         }
 150         return credElement;
 151     }
 152 
<span class="new"> 153     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,</span>
<span class="new"> 154            Map&lt;String,String&gt; store, int initLifetime, int acceptLifetime,</span>
<span class="new"> 155            int usage) throws GSSException {</span>
<span class="new"> 156 </span>
<span class="new"> 157         if (store != null) {</span>
<span class="new"> 158             // XXX Implement!  Shouldn't be too hard...</span>
<span class="new"> 159             throw new GSSException(GSSException.UNAVAILABLE, -1,</span>
<span class="new"> 160                     "The Kerberos mechanism Java implementation does not " +</span>
<span class="new"> 161                     "currently support acquiring GSS credentials handle " +</span>
<span class="new"> 162                     "elements using a \"credential store\"");</span>
<span class="new"> 163         }</span>
<span class="new"> 164 </span>
<span class="new"> 165         if (name != null &amp;&amp; !(name instanceof Krb5NameElement)) {</span>
<span class="new"> 166             name = Krb5NameElement.getInstance(name.toString(),</span>
<span class="new"> 167                                        name.getStringNameType());</span>
<span class="new"> 168         }</span>
<span class="new"> 169 </span>
<span class="new"> 170         Krb5CredElement credElement = getCredFromSubject</span>
<span class="new"> 171             (name, (usage != GSSCredential.ACCEPT_ONLY));</span>
<span class="new"> 172 </span>
<span class="new"> 173         if (credElement == null) {</span>
<span class="new"> 174             if (usage == GSSCredential.INITIATE_ONLY ||</span>
<span class="new"> 175                 usage == GSSCredential.INITIATE_AND_ACCEPT) {</span>
<span class="new"> 176                 credElement = Krb5InitCredential.getInstance</span>
<span class="new"> 177                     (caller, (Krb5NameElement) name, initLifetime);</span>
<span class="new"> 178                 checkInitCredPermission</span>
<span class="new"> 179                     ((Krb5NameElement) credElement.getName());</span>
<span class="new"> 180             } else if (usage == GSSCredential.ACCEPT_ONLY) {</span>
<span class="new"> 181                 credElement =</span>
<span class="new"> 182                     Krb5AcceptCredential.getInstance(caller,</span>
<span class="new"> 183                                                      (Krb5NameElement) name);</span>
<span class="new"> 184                 checkAcceptCredPermission</span>
<span class="new"> 185                     ((Krb5NameElement) credElement.getName(), name);</span>
<span class="new"> 186             } else</span>
<span class="new"> 187                 throw new GSSException(GSSException.FAILURE, -1,</span>
<span class="new"> 188                                        "Unknown usage mode requested");</span>
<span class="new"> 189         }</span>
<span class="new"> 190         return credElement;</span>
<span class="new"> 191     }</span>
<span class="new"> 192 </span>
<span class="new"> 193     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,</span>
<span class="new"> 194             int initLifetime, int acceptLifetime, int usage)</span>
<span class="new"> 195         throws GSSException {</span>
<span class="new"> 196         return getCredentialElement(name, initLifetime, acceptLifetime,</span>
<span class="new"> 197             usage);</span>
<span class="new"> 198     }</span>
<span class="new"> 199 </span>
<span class="new"> 200     public void storeCredInto(GSSCredentialSpi cred, int usage,</span>
<span class="new"> 201                               boolean overwrite, boolean defaultCred,</span>
<span class="new"> 202                               Map&lt;String,String&gt; store) throws GSSException {</span>
<span class="new"> 203         throw new GSSException(GSSException.UNAVAILABLE, -1,</span>
<span class="new"> 204                 "The Kerberos mechanism Java implementation does not " +</span>
<span class="new"> 205                 "currently support storing GSS credentials handle " +</span>
<span class="new"> 206                 "elements into a \"credential store\"");</span>
<span class="new"> 207     }</span>
<span class="new"> 208 </span>
 209     public static void checkInitCredPermission(Krb5NameElement name) {
 210         SecurityManager sm = System.getSecurityManager();
 211         if (sm != null) {
 212             String realm = (name.getKrb5PrincipalName()).getRealmAsString();
 213             String tgsPrincipal =
 214                 new String("krbtgt/" + realm + '@' + realm);
 215             ServicePermission perm =
 216                 new ServicePermission(tgsPrincipal, "initiate");
 217             try {
 218                 sm.checkPermission(perm);
 219             } catch (SecurityException e) {
 220                 if (DEBUG) {
<span class="changed"> 221                     System.out.println("Permission to initiate " +</span>
 222                         "kerberos init credential" + e.getMessage());
 223                 }
 224                 throw e;
 225             }
 226         }
 227     }
 228 
 229     public static void checkAcceptCredPermission(Krb5NameElement name,
 230                                            GSSNameSpi originalName) {
 231         SecurityManager sm = System.getSecurityManager();
 232         if (sm != null &amp;&amp; name != null) {
 233             ServicePermission perm = new ServicePermission
 234                 (name.getKrb5PrincipalName().getName(), "accept");
 235             try {
 236                 sm.checkPermission(perm);
 237             } catch (SecurityException e) {
 238                 if (originalName == null) {
 239                     // Don't disclose the name of the principal
 240                     e = new SecurityException("No permission to acquire "
 241                                       + "Kerberos accept credential");

</pre><hr></hr>
</pre></td>
</tr></table>
</body></html>
