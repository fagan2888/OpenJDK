<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>ws Wdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java</title>

    <meta http-equiv="cache-control" content="no-cache" />

    <style type='text/css' media='screen'>
      pre	{ margin: 2px; }

      body	{ background-color: #eeeeee; }

      hr	{ border: none 0; border-top: 1px solid #aaa; height: 1px; }

      .subtracted { color: brown }
      .added	{ color: blue }

      .elided	{ border: 1px solid #444; cursor: pointer; margin: 1px }

      table.hidebar { border: 1px solid #ff9900; background-color: #eee;
      		  text-align: center; border-collapse: collapse; }

      .hidebar td.active-down { border: 1px solid #ff9900;
		border-right: 1px solid #ccc; cursor: s-resize }

      .hidebar td.active-down:hover { background-color: #ffcc99; }

      .hidebar td.active-up { border: 1px solid #ff9900; cursor: n-resize;
		border-left: 1px solid #ccc; }

      .hidebar td.active-up:hover { background-color: #ffcc99; }

      .hidebar td.elided-label { font-style: italic; width: 12em; }

      .cmdbox	{ position: fixed; top: 0; right: 0;
	          border-left: solid 1px #444;
	          border-bottom: solid 1px #444;
      		  background-color: #ccc; text-align: center }

      .cmdbox td { background-color: #eee; border: 1px #444 outset;
		   cursor: pointer; padding: 3px 4px; }
      .cmdbox td:hover { background-color: #ffcc99;
 		outline: thin solid #ff9900; }

      a:hover { background-color: #ffcc99; }

      a.print { font-size: x-small; }
    </style>

    <style type='text/css' media='print'>
	pre { font-family: courier, monospace; font-size: 0.8em; }
	.cmdbox { display: none; }
        a.print { display: none; }
	.hidebar td.active-down { display: none; }
	.hidebar td.active-up { display: none; }
        .hidebar td.elided-label { font-style: italic; font-size: small; }
	table.hidebar { border: none; border-bottom: 1px dotted #000000; }
	span.added { font-weight: bold;
	         background-color: #eee; width: 100%; display: block; }
	span.subtracted { font-style: italic;
		 background-color: #eee; width: 100%; display: block; }
	.elided { display: none; }
        hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
    </style>

    <script type="text/javascript">
      function show_n_hide_dir(id_to_show, id_to_hide, dir) {
	      var elt_to_show = document.getElementById(id_to_show);
	      var elt_to_hide = document.getElementById(id_to_hide);
	      // When we're opening up, we need to make the bottoms of the
	      // elements appear to be the same.  So our invariant should be
	      // elt.offsetBottom - window.scrollY.
	      var preinvar = elt_to_hide.offsetHeight - window.scrollY;
	      elt_to_show.style.setProperty('display', '', '');
	      elt_to_hide.style.setProperty('display', 'none', '');
	      if (dir == 'up') {
		      var postinvar = elt_to_show.offsetHeight - window.scrollY;
		      window.scrollBy(0, postinvar - preinvar);
	      }
      }

      function handle_click(e) {
	      var eh = e.target;
	      var es = document.getElementById("hb-" + e.target.id);
	      eh.style.setProperty('display', 'none', '');
	      es.style.setProperty('display', '', '');
	      /* Scroll so new element is at cursor. */
	      window.scroll(0, es.offsetTop + (es.offsetHeight / 2)
	          - e.clientY);
      }

      function stripsearch(str) {
	q = str.indexOf("?");
	if (q != -1)
	  str = str.substr(0, q);
	return (str);
      }

      function split() {
        page = stripsearch(location.href);
	halfway = window.scrollY + window.innerHeight / 2 - 5;
	document.write('<frameset rows="50%,*">' +
	  '<frame src="' + page + "?" + window.scrollY + '" />' +
	  '<frame src="' + page + "?" + halfway + '" />' +
	  '</frameset>');
	document.close();
      }

      function closeframe() {
	page = stripsearch(location.href);

	otherf = window.parent.frames[0];
	if (otherf == window)
	  otherf = window.parent.frames[1];

	parent.location.replace(page + "?" + otherf.scrollY);
      }
    </script>
  </head>
  <body id='SUNWwebrev'>
    <a class="print" href="javascript:print()">Print this page</a>
    <pre>
Add isDefaultCredential() method to GSSCredentialSpi
</pre>
<hr />
    <table class='cmdbox'>
      <tr>
        <td onclick='split()'>Split</td>
	<td id='close' onclick='closeframe()'>Close</td>
      </tr>
      <tr><td colspan="2" onclick='open_or_close_all(1)'>Expand all</td></tr>
      <tr><td colspan="2" onclick='open_or_close_all(0)'>Collapse all</td></tr>
    </table>

    <script type='text/javascript'>
      if (window == top)
        document.getElementById('close').style.setProperty('display', 'none', '');
    </script>
<pre><span class='subtracted'>          --- old/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java
</span><span class='added'>          +++ new/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5AcceptCredential.java
</span></pre>
<pre id='elided1' class='elided' style='display: none'>   1    1  /*
   2    2   * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.
   3    3   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4    4   *
   5    5   * This code is free software; you can redistribute it and/or modify it
   6    6   * under the terms of the GNU General Public License version 2 only, as
   7    7   * published by the Free Software Foundation.  Oracle designates this
   8    8   * particular file as subject to the "Classpath" exception as provided
   9    9   * by Oracle in the LICENSE file that accompanied this code.
  10   10   *
  11   11   * This code is distributed in the hope that it will be useful, but WITHOUT
  12   12   * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13   13   * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14   14   * version 2 for more details (a copy is included in the LICENSE file that
  15   15   * accompanied this code).
  16   16   *
  17   17   * You should have received a copy of the GNU General Public License version
  18   18   * 2 along with this work; if not, write to the Free Software Foundation,
  19   19   * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20   20   *
  21   21   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22   22   * or visit www.oracle.com if you need additional information or have any
  23   23   * questions.
  24   24   */
  25   25  
  26   26  package sun.security.jgss.krb5;
  27   27  
  28   28  import java.io.IOException;
  29   29  import org.ietf.jgss.*;
  30   30  import sun.security.jgss.GSSCaller;
  31   31  import sun.security.jgss.spi.*;
  32   32  import sun.security.krb5.*;
  33   33  import java.security.PrivilegedActionException;
  34   34  import java.security.PrivilegedExceptionAction;
  35   35  import java.security.AccessController;
  36   36  import java.security.AccessControlContext;
  37   37  import javax.security.auth.DestroyFailedException;
  38   38  
  39   39  /**
</pre>
<table id='hb-elided1' class='hidebar'>
  <tr>
    <td class='active-down'
      onclick='show_n_hide_dir("elided1", "hb-elided1", "down")'>
      &darr;&nbsp;open down&nbsp;&darr;</td>
    <td class="elided-label">39 lines elided</td>
    <td class='active-up'
      onclick='show_n_hide_dir("elided1", "hb-elided1", "up")'>
      &uarr;&nbsp;open up&nbsp;&uarr;</td>
  </tr>
</table>
<pre>  40   40   * Implements the krb5 acceptor credential element.
  41   41   *
  42   42   * @author Mayank Upadhyay
  43   43   * @since 1.4
  44   44   */
  45   45  public class Krb5AcceptCredential
  46   46      implements Krb5CredElement {
  47   47  
  48   48      private final Krb5NameElement name;
  49   49      private final ServiceCreds screds;
<span class='added'>       50 +    private boolean isDefCred = false;
</span>  50   51  
  51   52      private Krb5AcceptCredential(Krb5NameElement name, ServiceCreds creds) {
  52   53          /*
  53   54           * Initialize this instance with the data from the acquired
  54   55           * KerberosKey. This class needs to be a KerberosKey too
  55   56           * hence we can't just store a reference.
  56   57           */
  57   58  
  58   59          this.name = name;
  59   60          this.screds = creds;
<span class='added'>       61 +        if (name == null)
       62 +            isDefCred = true;
</span>  60   63      }
  61   64  
  62   65      static Krb5AcceptCredential getInstance(final GSSCaller caller, Krb5NameElement name)
  63   66          throws GSSException {
  64   67  
  65   68          final String serverPrinc = (name == null? null:
  66   69              name.getKrb5PrincipalName().getName());
  67   70          final AccessControlContext acc = AccessController.getContext();
  68   71  
  69   72          ServiceCreds creds = null;
</pre>
<pre id='elided2' class='elided' style='display: none'>  70   73          try {
  71   74              creds = AccessController.doPrivileged(
  72   75                          new PrivilegedExceptionAction&lt;ServiceCreds&gt;() {
  73   76                  public ServiceCreds run() throws Exception {
  74   77                      return Krb5Util.getServiceCreds(
  75   78                          caller == GSSCaller.CALLER_UNKNOWN ? GSSCaller.CALLER_ACCEPT: caller,
  76   79                          serverPrinc, acc);
  77   80                  }});
  78   81          } catch (PrivilegedActionException e) {
  79   82              GSSException ge =
  80   83                  new GSSException(GSSException.NO_CRED, -1,
  81   84                      "Attempt to obtain new ACCEPT credentials failed!");
  82   85              ge.initCause(e.getException());
  83   86              throw ge;
  84   87          }
  85   88  
  86   89          if (creds == null)
  87   90              throw new GSSException(GSSException.NO_CRED, -1,
  88   91                                     "Failed to find any Kerberos credentials");
  89   92  
  90   93          if (name == null) {
  91   94              String fullName = creds.getName();
  92   95              if (fullName != null) {
  93   96                  name = Krb5NameElement.getInstance(fullName,
  94   97                                         Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
  95   98              }
  96   99          }
  97  100  
  98  101          return new Krb5AcceptCredential(name, creds);
  99  102      }
 100  103  
 101  104      /**
 102  105       * Returns the principal name for this credential. The name
 103  106       * is in mechanism specific format.
 104  107       *
 105  108       * @return GSSNameSpi representing principal name of this credential
 106  109       * @exception GSSException may be thrown
 107  110       */
 108  111      public final GSSNameSpi getName() throws GSSException {
 109  112          return name;
 110  113      }
 111  114  
 112  115      /**
 113  116       * Returns the init lifetime remaining.
 114  117       *
 115  118       * @return the init lifetime remaining in seconds
 116  119       * @exception GSSException may be thrown
 117  120       */
 118  121      public int getInitLifetime() throws GSSException {
 119  122          return 0;
 120  123      }
 121  124  
 122  125      /**
 123  126       * Returns the accept lifetime remaining.
 124  127       *
 125  128       * @return the accept lifetime remaining in seconds
 126  129       * @exception GSSException may be thrown
 127  130       */
 128  131      public int getAcceptLifetime() throws GSSException {
 129  132          return GSSCredential.INDEFINITE_LIFETIME;
 130  133      }
 131  134  
 132  135      public boolean isInitiatorCredential() throws GSSException {
 133  136          return false;
 134  137      }
 135  138  
 136  139      public boolean isAcceptorCredential() throws GSSException {
 137  140          return true;
 138  141      }
</pre>
<table id='hb-elided2' class='hidebar'>
  <tr>
    <td class='active-down'
      onclick='show_n_hide_dir("elided2", "hb-elided2", "down")'>
      &darr;&nbsp;open down&nbsp;&darr;</td>
    <td class="elided-label">69 lines elided</td>
    <td class='active-up'
      onclick='show_n_hide_dir("elided2", "hb-elided2", "up")'>
      &uarr;&nbsp;open up&nbsp;&uarr;</td>
  </tr>
</table>
<pre> 139  142  
 140  143      /**
 141  144       * Returns the oid representing the underlying credential
 142  145       * mechanism oid.
 143  146       *
 144  147       * @return the Oid for this credential mechanism
 145  148       * @exception GSSException may be thrown
 146  149       */
 147  150      public final Oid getMechanism() {
 148  151          return Krb5MechFactory.GSS_KRB5_MECH_OID;
<span class='added'>      152 +    }
      153 +
      154 +    /**
      155 +     * Returns true if the credential is a default credential.
      156 +     *
      157 +     * @return true if the credential is a default credential, else false.
      158 +     */
      159 +    public boolean isDefaultCredential() {
      160 +        return isDefCred;
</span> 149  161      }
 150  162  
 151  163      public final java.security.Provider getProvider() {
 152  164          return Krb5MechFactory.PROVIDER;
 153  165      }
 154  166  
 155  167      public EncryptionKey[] getKrb5EncryptionKeys(PrincipalName princ) {
 156  168          return screds.getEKeys(princ);
 157  169      }
 158  170  
</pre>
<pre id='elided3' class='elided' style='display: none'> 159  171      /**
 160  172       * Called to invalidate this credential element.
 161  173       */
 162  174      public void dispose() throws GSSException {
 163  175          try {
 164  176              destroy();
 165  177          } catch (DestroyFailedException e) {
 166  178              GSSException gssException =
 167  179                  new GSSException(GSSException.FAILURE, -1,
 168  180                   "Could not destroy credentials - " + e.getMessage());
 169  181              gssException.initCause(e);
 170  182          }
 171  183      }
 172  184  
 173  185      /**
 174  186       * Destroys the locally cached EncryptionKey value and then calls
 175  187       * destroy in the base class.
 176  188       */
 177  189      public void destroy() throws DestroyFailedException {
 178  190          screds.destroy();
 179  191      }
 180  192  
 181  193      /**
 182  194       * Impersonation is only available on the initiator side. The
 183  195       * service must starts as an initiator to get an initial TGT to complete
 184  196       * the S4U2self protocol.
 185  197       */
 186  198      @Override
 187  199      public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
 188  200          Credentials cred = screds.getInitCred();
 189  201          if (cred != null) {
 190  202              return Krb5InitCredential.getInstance(this.name, cred)
 191  203                      .impersonate(name);
 192  204          } else {
 193  205              throw new GSSException(GSSException.FAILURE, -1,
 194  206                  "Only an initiate credentials can impersonate");
 195  207          }
 196  208      }
 197  209  }
</pre>
<table id='hb-elided3' class='hidebar'>
  <tr>
    <td class='active-down'
      onclick='show_n_hide_dir("elided3", "hb-elided3", "down")'>
      &darr;&nbsp;open down&nbsp;&darr;</td>
    <td class="elided-label">39 lines elided</td>
    <td class='active-up'
      onclick='show_n_hide_dir("elided3", "hb-elided3", "up")'>
      &uarr;&nbsp;open up&nbsp;&uarr;</td>
  </tr>
</table>
<pre id='linerefpre'><span id='lineref'>XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></pre>
    <br clear="all" />
    <br />

    <script type="text/javascript">
      /* Assign event handlers and widths. */
      var w = document.getElementById('lineref').offsetWidth;
      for (var i = 1; i <= 3; ++i) {
	      var e = document.getElementById("elided" + i);
	      e.onclick = handle_click;
              e.style.setProperty('width', w + "px", '');

	      e = document.getElementById("hb-elided" + i);
              e.style.setProperty('width', w + "px", '');
      }

      /* Hide our line size reference. */
      document.getElementById('linerefpre').style.setProperty('display',
          'none', '');

      /* Scroll as indicated. */
      str = location.search;
      s = str.substring(1, str.length);
      if (s > 0)
        window.scroll(0, s);

      function open_or_close_all(open) {
	      for (var i = 1; i <= 3; ++i) {
		      var e = document.getElementById("hb-elided" + i);
		      e.style.setProperty("display", open ? "none" : "", "");

		      e = document.getElementById("elided" + i);
		      e.style.setProperty("display", open ? "" : "none", "");
	      }
      }
    </script>
  </body>
</html>
