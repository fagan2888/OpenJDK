<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre>Add isDefaultCredential() method to GSSCredentialSpi</pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.krb5;
  27 
  28 import java.io.IOException;
  29 import org.ietf.jgss.*;
  30 import sun.security.jgss.GSSCaller;
  31 import sun.security.jgss.spi.*;
  32 import sun.security.krb5.*;
  33 import java.security.PrivilegedActionException;
  34 import java.security.PrivilegedExceptionAction;
  35 import java.security.AccessController;
  36 import java.security.AccessControlContext;
  37 import javax.security.auth.DestroyFailedException;
  38 
  39 /**
  40  * Implements the krb5 acceptor credential element.
  41  *
  42  * @author Mayank Upadhyay
  43  * @since 1.4
  44  */
  45 public class Krb5AcceptCredential
  46     implements Krb5CredElement {
  47 
  48     private final Krb5NameElement name;
  49     private final ServiceCreds screds;
<a name="1" id="anc1"></a><span class="new">  50     private boolean isDefCred = false;</span>
  51 
  52     private Krb5AcceptCredential(Krb5NameElement name, ServiceCreds creds) {
  53         /*
  54          * Initialize this instance with the data from the acquired
  55          * KerberosKey. This class needs to be a KerberosKey too
  56          * hence we can't just store a reference.
  57          */
  58 
  59         this.name = name;
  60         this.screds = creds;
<a name="2" id="anc2"></a><span class="new">  61         if (name == null)</span>
<span class="new">  62             isDefCred = true;</span>
  63     }
  64 
  65     static Krb5AcceptCredential getInstance(final GSSCaller caller, Krb5NameElement name)
  66         throws GSSException {
  67 
  68         final String serverPrinc = (name == null? null:
  69             name.getKrb5PrincipalName().getName());
  70         final AccessControlContext acc = AccessController.getContext();
  71 
  72         ServiceCreds creds = null;
  73         try {
  74             creds = AccessController.doPrivileged(
  75                         new PrivilegedExceptionAction&lt;ServiceCreds&gt;() {
  76                 public ServiceCreds run() throws Exception {
  77                     return Krb5Util.getServiceCreds(
  78                         caller == GSSCaller.CALLER_UNKNOWN ? GSSCaller.CALLER_ACCEPT: caller,
  79                         serverPrinc, acc);
  80                 }});
  81         } catch (PrivilegedActionException e) {
  82             GSSException ge =
  83                 new GSSException(GSSException.NO_CRED, -1,
  84                     "Attempt to obtain new ACCEPT credentials failed!");
  85             ge.initCause(e.getException());
  86             throw ge;
  87         }
  88 
  89         if (creds == null)
  90             throw new GSSException(GSSException.NO_CRED, -1,
  91                                    "Failed to find any Kerberos credentials");
  92 
  93         if (name == null) {
  94             String fullName = creds.getName();
  95             if (fullName != null) {
  96                 name = Krb5NameElement.getInstance(fullName,
  97                                        Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
  98             }
  99         }
 100 
 101         return new Krb5AcceptCredential(name, creds);
 102     }
 103 
 104     /**
 105      * Returns the principal name for this credential. The name
 106      * is in mechanism specific format.
 107      *
 108      * @return GSSNameSpi representing principal name of this credential
 109      * @exception GSSException may be thrown
 110      */
 111     public final GSSNameSpi getName() throws GSSException {
 112         return name;
 113     }
 114 
 115     /**
 116      * Returns the init lifetime remaining.
 117      *
 118      * @return the init lifetime remaining in seconds
 119      * @exception GSSException may be thrown
 120      */
 121     public int getInitLifetime() throws GSSException {
 122         return 0;
 123     }
 124 
 125     /**
 126      * Returns the accept lifetime remaining.
 127      *
 128      * @return the accept lifetime remaining in seconds
 129      * @exception GSSException may be thrown
 130      */
 131     public int getAcceptLifetime() throws GSSException {
 132         return GSSCredential.INDEFINITE_LIFETIME;
 133     }
 134 
 135     public boolean isInitiatorCredential() throws GSSException {
 136         return false;
 137     }
 138 
 139     public boolean isAcceptorCredential() throws GSSException {
 140         return true;
 141     }
 142 
 143     /**
 144      * Returns the oid representing the underlying credential
 145      * mechanism oid.
 146      *
 147      * @return the Oid for this credential mechanism
 148      * @exception GSSException may be thrown
 149      */
 150     public final Oid getMechanism() {
 151         return Krb5MechFactory.GSS_KRB5_MECH_OID;
<a name="3" id="anc3"></a><span class="new"> 152     }</span>
<span class="new"> 153 </span>
<span class="new"> 154     /**</span>
<span class="new"> 155      * Returns true if the credential is a default credential.</span>
<span class="new"> 156      *</span>
<span class="new"> 157      * @return true if the credential is a default credential, else false.</span>
<span class="new"> 158      */</span>
<span class="new"> 159     public boolean isDefaultCredential() {</span>
<span class="new"> 160         return isDefCred;</span>
 161     }
 162 
 163     public final java.security.Provider getProvider() {
 164         return Krb5MechFactory.PROVIDER;
 165     }
 166 
 167     public EncryptionKey[] getKrb5EncryptionKeys(PrincipalName princ) {
 168         return screds.getEKeys(princ);
 169     }
 170 
 171     /**
 172      * Called to invalidate this credential element.
 173      */
 174     public void dispose() throws GSSException {
 175         try {
 176             destroy();
 177         } catch (DestroyFailedException e) {
 178             GSSException gssException =
 179                 new GSSException(GSSException.FAILURE, -1,
 180                  "Could not destroy credentials - " + e.getMessage());
 181             gssException.initCause(e);
 182         }
 183     }
 184 
 185     /**
 186      * Destroys the locally cached EncryptionKey value and then calls
 187      * destroy in the base class.
 188      */
 189     public void destroy() throws DestroyFailedException {
 190         screds.destroy();
 191     }
 192 
 193     /**
 194      * Impersonation is only available on the initiator side. The
 195      * service must starts as an initiator to get an initial TGT to complete
 196      * the S4U2self protocol.
 197      */
 198     @Override
 199     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
 200         Credentials cred = screds.getInitCred();
 201         if (cred != null) {
 202             return Krb5InitCredential.getInstance(this.name, cred)
 203                     .impersonate(name);
 204         } else {
 205             throw new GSSException(GSSException.FAILURE, -1,
 206                 "Only an initiate credentials can impersonate");
 207         }
 208     }
 209 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="4" type="hidden"></input></form></body></html>
