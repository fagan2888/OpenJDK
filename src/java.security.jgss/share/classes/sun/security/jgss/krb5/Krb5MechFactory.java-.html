<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Old src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5MechFactory.java</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.krb5;
  27 
  28 import org.ietf.jgss.*;
  29 import sun.security.jgss.GSSUtil;
  30 import sun.security.jgss.GSSCaller;
  31 import sun.security.jgss.spi.*;
  32 import javax.security.auth.kerberos.ServicePermission;
  33 import java.security.Provider;
  34 import java.util.Vector;
  35 
  36 /**
  37  * Krb5 Mechanism plug in for JGSS
  38  * This is the properties object required by the JGSS framework.
  39  * All mechanism specific information is defined here.
  40  *
  41  * @author Mayank Upadhyay
  42  */
  43 
  44 public final class Krb5MechFactory implements MechanismFactory {
  45 
  46     private static final boolean DEBUG = Krb5Util.DEBUG;
  47 
  48     static final Provider PROVIDER =
  49         new sun.security.jgss.SunProvider();
  50 
  51     static final Oid GSS_KRB5_MECH_OID =
  52         createOid("1.2.840.113554.1.2.2");
  53 
  54     static final Oid NT_GSS_KRB5_PRINCIPAL =
  55         createOid("1.2.840.113554.1.2.2.1");
  56 
  57     private static Oid[] nameTypes =
  58         new Oid[] { GSSName.NT_USER_NAME,
  59                         GSSName.NT_HOSTBASED_SERVICE,
  60                         GSSName.NT_EXPORT_NAME,
  61                         NT_GSS_KRB5_PRINCIPAL};
  62 
  63     final private GSSCaller caller;
  64 
  65     private static Krb5CredElement getCredFromSubject(GSSNameSpi name,
  66                                                       boolean initiate)
  67         throws GSSException {
  68         Vector&lt;Krb5CredElement&gt; creds =
  69             GSSUtil.searchSubject(name, GSS_KRB5_MECH_OID, initiate,
  70                                   (initiate ?
  71                                    Krb5InitCredential.class :
  72                                    Krb5AcceptCredential.class));
  73 
  74         Krb5CredElement result = ((creds == null || creds.isEmpty()) ?
  75                                   null : creds.firstElement());
  76 
  77         // Force permission check before returning the cred to caller
  78         if (result != null) {
  79             if (initiate) {
  80                 checkInitCredPermission((Krb5NameElement) result.getName());
  81             } else {
  82                 checkAcceptCredPermission
  83                     ((Krb5NameElement) result.getName(), name);
  84             }
  85         }
  86         return result;
  87     }
  88 
  89     public Krb5MechFactory() {
  90         this(GSSCaller.CALLER_UNKNOWN);
  91     }
  92 
  93     public Krb5MechFactory(GSSCaller caller) {
  94         this.caller = caller;
  95     }
  96 
  97     public GSSNameSpi getNameElement(String nameStr, Oid nameType)
  98         throws GSSException {
  99         return Krb5NameElement.getInstance(nameStr, nameType);
 100     }
 101 
 102     public GSSNameSpi getNameElement(byte[] name, Oid nameType)
 103         throws GSSException {
 104         // At this point, even an exported name is stripped down to safe
 105         // bytes only
 106         // XXX Use encoding here
 107         return Krb5NameElement.getInstance(new String(name), nameType);
 108     }
 109 
 110     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,
 111            int initLifetime, int acceptLifetime,
 112            int usage) throws GSSException {
 113 
 114         if (name != null &amp;&amp; !(name instanceof Krb5NameElement)) {
 115             name = Krb5NameElement.getInstance(name.toString(),
 116                                        name.getStringNameType());
 117         }
 118 
 119         Krb5CredElement credElement = getCredFromSubject
 120             (name, (usage != GSSCredential.ACCEPT_ONLY));
 121 
 122         if (credElement == null) {
 123             if (usage == GSSCredential.INITIATE_ONLY ||
 124                 usage == GSSCredential.INITIATE_AND_ACCEPT) {
 125                 credElement = Krb5InitCredential.getInstance
 126                     (caller, (Krb5NameElement) name, initLifetime);
 127                 credElement = Krb5ProxyCredential.tryImpersonation(
 128                         caller, (Krb5InitCredential)credElement);
 129                 checkInitCredPermission
 130                     ((Krb5NameElement) credElement.getName());
 131             } else if (usage == GSSCredential.ACCEPT_ONLY) {
 132                 credElement =
 133                     Krb5AcceptCredential.getInstance(caller,
 134                                                      (Krb5NameElement) name);
 135                 checkAcceptCredPermission
 136                     ((Krb5NameElement) credElement.getName(), name);
 137             } else
 138                 throw new GSSException(GSSException.FAILURE, -1,
 139                                        "Unknown usage mode requested");
 140         }
 141         return credElement;
 142     }
 143 
 144     public static void checkInitCredPermission(Krb5NameElement name) {
 145         SecurityManager sm = System.getSecurityManager();
 146         if (sm != null) {
 147             String realm = (name.getKrb5PrincipalName()).getRealmAsString();
 148             String tgsPrincipal =
 149                 new String("krbtgt/" + realm + '@' + realm);
 150             ServicePermission perm =
 151                 new ServicePermission(tgsPrincipal, "initiate");
 152             try {
 153                 sm.checkPermission(perm);
 154             } catch (SecurityException e) {
 155                 if (DEBUG) {
 156                     System.out.println("Permission to initiate" +
 157                         "kerberos init credential" + e.getMessage());
 158                 }
 159                 throw e;
 160             }
 161         }
 162     }
 163 
 164     public static void checkAcceptCredPermission(Krb5NameElement name,
 165                                            GSSNameSpi originalName) {
 166         SecurityManager sm = System.getSecurityManager();
 167         if (sm != null &amp;&amp; name != null) {
 168             ServicePermission perm = new ServicePermission
 169                 (name.getKrb5PrincipalName().getName(), "accept");
 170             try {
 171                 sm.checkPermission(perm);
 172             } catch (SecurityException e) {
 173                 if (originalName == null) {
 174                     // Don't disclose the name of the principal
 175                     e = new SecurityException("No permission to acquire "
 176                                       + "Kerberos accept credential");
 177                     // Don't call e.initCause() with caught exception
 178                 }
 179                 throw e;
 180             }
 181         }
 182     }
 183 
 184     public GSSContextSpi getMechanismContext(GSSNameSpi peer,
 185                              GSSCredentialSpi myInitiatorCred, int lifetime)
 186         throws GSSException {
 187         if (peer != null &amp;&amp; !(peer instanceof Krb5NameElement)) {
 188             peer = Krb5NameElement.getInstance(peer.toString(),
 189                                        peer.getStringNameType());
 190         }
 191         // XXX Convert myInitiatorCred to Krb5CredElement
 192         if (myInitiatorCred == null) {
 193             myInitiatorCred = getCredentialElement(null, lifetime, 0,
 194                 GSSCredential.INITIATE_ONLY);
 195         }
 196         return new Krb5Context(caller, (Krb5NameElement)peer,
 197                                (Krb5CredElement)myInitiatorCred, lifetime);
 198     }
 199 
 200     public GSSContextSpi getMechanismContext(GSSCredentialSpi myAcceptorCred)
 201         throws GSSException {
 202         // XXX Convert myAcceptorCred to Krb5CredElement
 203         if (myAcceptorCred == null) {
 204             myAcceptorCred = getCredentialElement(null, 0,
 205                 GSSCredential.INDEFINITE_LIFETIME, GSSCredential.ACCEPT_ONLY);
 206         }
 207         return new Krb5Context(caller, (Krb5CredElement)myAcceptorCred);
 208     }
 209 
 210     public GSSContextSpi getMechanismContext(byte[] exportedContext)
 211         throws GSSException {
 212         return new Krb5Context(caller, exportedContext);
 213     }
 214 
 215 
 216     public final Oid getMechanismOid() {
 217         return GSS_KRB5_MECH_OID;
 218     }
 219 
 220     public Provider getProvider() {
 221         return PROVIDER;
 222     }
 223 
 224     public Oid[] getNameTypes() {
 225         // nameTypes is cloned in GSSManager.getNamesForMech
 226         return nameTypes;
 227     }
 228 
 229     private static Oid createOid(String oidStr) {
 230         Oid retVal = null;
 231         try {
 232             retVal = new Oid(oidStr);
 233         } catch (GSSException e) {
 234             // Should not happen!
 235         }
 236         return retVal;
 237     }
 238 }
</pre></body></html>
