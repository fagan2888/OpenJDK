<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre>Add isDefaultCredential() method to GSSCredentialSpi</pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.krb5;
  27 
  28 import org.ietf.jgss.*;
  29 import sun.security.jgss.GSSCaller;
  30 import sun.security.jgss.spi.*;
  31 import sun.security.krb5.*;
  32 import javax.security.auth.kerberos.KerberosTicket;
  33 import javax.security.auth.kerberos.KerberosPrincipal;
  34 import java.net.InetAddress;
  35 import java.io.IOException;
  36 import java.util.Date;
  37 import java.security.AccessController;
  38 import java.security.AccessControlContext;
  39 import java.security.PrivilegedExceptionAction;
  40 import java.security.PrivilegedActionException;
  41 
  42 /**
  43  * Implements the krb5 initiator credential element.
  44  *
  45  * @author Mayank Upadhyay
  46  * @author Ram Marti
  47  * @since 1.4
  48  */
  49 
  50 public class Krb5InitCredential
  51     extends KerberosTicket
  52     implements Krb5CredElement {
  53 
  54     private static final long serialVersionUID = 7723415700837898232L;
  55 
  56     private Krb5NameElement name;
  57     private Credentials krb5Credentials;
  58     public KerberosTicket proxyTicket;
<a name="1" id="anc1"></a><span class="new">  59     private boolean isDefCred;</span>
  60 
  61     private Krb5InitCredential(Krb5NameElement name,
  62                                byte[] asn1Encoding,
  63                                KerberosPrincipal client,
  64                                KerberosPrincipal clientAlias,
  65                                KerberosPrincipal server,
  66                                KerberosPrincipal serverAlias,
  67                                byte[] sessionKey,
  68                                int keyType,
  69                                boolean[] flags,
  70                                Date authTime,
  71                                Date startTime,
  72                                Date endTime,
  73                                Date renewTill,
  74                                InetAddress[] clientAddresses)
  75                                throws GSSException {
  76         super(asn1Encoding,
  77               client,
  78               server,
  79               sessionKey,
  80               keyType,
  81               flags,
  82               authTime,
  83               startTime,
  84               endTime,
  85               renewTill,
  86               clientAddresses);
  87         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
  88                 .kerberosTicketSetClientAlias(this, clientAlias);
  89         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
  90                 .kerberosTicketSetServerAlias(this, serverAlias);
  91         this.name = name;
<a name="2" id="anc2"></a><span class="new">  92         if (name == null)</span>
<span class="new">  93             isDefCred = true;</span>
  94 
  95         try {
  96             // Cache this for later use by the sun.security.krb5 package.
  97             krb5Credentials = new Credentials(asn1Encoding,
  98                                               client.getName(),
  99                                               (clientAlias != null ?
 100                                                       clientAlias.getName() : null),
 101                                               server.getName(),
 102                                               (serverAlias != null ?
 103                                                       serverAlias.getName() : null),
 104                                               sessionKey,
 105                                               keyType,
 106                                               flags,
 107                                               authTime,
 108                                               startTime,
 109                                               endTime,
 110                                               renewTill,
 111                                               clientAddresses);
 112         } catch (KrbException e) {
 113             throw new GSSException(GSSException.NO_CRED, -1,
 114                                    e.getMessage());
 115         } catch (IOException e) {
 116             throw new GSSException(GSSException.NO_CRED, -1,
 117                                    e.getMessage());
 118         }
 119 
 120     }
 121 
 122     private Krb5InitCredential(Krb5NameElement name,
 123                                Credentials delegatedCred,
 124                                byte[] asn1Encoding,
 125                                KerberosPrincipal client,
 126                                KerberosPrincipal clientAlias,
 127                                KerberosPrincipal server,
 128                                KerberosPrincipal serverAlias,
 129                                byte[] sessionKey,
 130                                int keyType,
 131                                boolean[] flags,
 132                                Date authTime,
 133                                Date startTime,
 134                                Date endTime,
 135                                Date renewTill,
 136                                InetAddress[] clientAddresses)
 137                                throws GSSException {
 138         super(asn1Encoding,
 139               client,
 140               server,
 141               sessionKey,
 142               keyType,
 143               flags,
 144               authTime,
 145               startTime,
 146               endTime,
 147               renewTill,
 148               clientAddresses);
 149         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
 150                 .kerberosTicketSetClientAlias(this, clientAlias);
 151         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
 152                 .kerberosTicketSetServerAlias(this, serverAlias);
 153         this.name = name;
 154         // A delegated cred does not have all fields set. So do not try to
<a name="3" id="anc3"></a><span class="changed"> 155         // creat new Credentials out of the delegatedCred.  Also, a delegated</span>
<span class="changed"> 156         // credential is not a default credential.</span>
 157         this.krb5Credentials = delegatedCred;
 158     }
 159 
 160     static Krb5InitCredential getInstance(GSSCaller caller, Krb5NameElement name,
 161                                    int initLifetime)
 162         throws GSSException {
 163 
 164         KerberosTicket tgt = getTgt(caller, name, initLifetime);
 165         if (tgt == null)
 166             throw new GSSException(GSSException.NO_CRED, -1,
 167                                    "Failed to find any Kerberos tgt");
 168 
 169         if (name == null) {
 170             String fullName = tgt.getClient().getName();
 171             name = Krb5NameElement.getInstance(fullName,
 172                                        Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
 173         }
 174 
 175         KerberosPrincipal clientAlias = KerberosSecrets
 176                 .getJavaxSecurityAuthKerberosAccess()
 177                 .kerberosTicketGetClientAlias(tgt);
 178         KerberosPrincipal serverAlias = KerberosSecrets
 179                 .getJavaxSecurityAuthKerberosAccess()
 180                 .kerberosTicketGetServerAlias(tgt);
 181         Krb5InitCredential result = new Krb5InitCredential(name,
 182                                       tgt.getEncoded(),
 183                                       tgt.getClient(),
 184                                       clientAlias,
 185                                       tgt.getServer(),
 186                                       serverAlias,
 187                                       tgt.getSessionKey().getEncoded(),
 188                                       tgt.getSessionKeyType(),
 189                                       tgt.getFlags(),
 190                                       tgt.getAuthTime(),
 191                                       tgt.getStartTime(),
 192                                       tgt.getEndTime(),
 193                                       tgt.getRenewTill(),
 194                                       tgt.getClientAddresses());
 195         result.proxyTicket = KerberosSecrets.getJavaxSecurityAuthKerberosAccess().
 196             kerberosTicketGetProxy(tgt);
 197         return result;
 198     }
 199 
 200     static Krb5InitCredential getInstance(Krb5NameElement name,
 201                                    Credentials delegatedCred)
 202         throws GSSException {
 203 
 204         EncryptionKey sessionKey = delegatedCred.getSessionKey();
 205 
 206         /*
 207          * all of the following data is optional in a KRB-CRED
 208          * messages. This check for each field.
 209          */
 210 
 211         PrincipalName cPrinc = delegatedCred.getClient();
 212         PrincipalName cAPrinc = delegatedCred.getClientAlias();
 213         PrincipalName sPrinc = delegatedCred.getServer();
 214         PrincipalName sAPrinc = delegatedCred.getServerAlias();
 215 
 216         KerberosPrincipal client = null;
 217         KerberosPrincipal clientAlias = null;
 218         KerberosPrincipal server = null;
 219         KerberosPrincipal serverAlias = null;
 220 
 221         Krb5NameElement credName = null;
 222 
 223         if (cPrinc != null) {
 224             String fullName = cPrinc.getName();
 225             credName = Krb5NameElement.getInstance(fullName,
 226                                Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
 227             client =  new KerberosPrincipal(fullName);
 228         }
 229 
 230         if (cAPrinc != null) {
 231             clientAlias = new KerberosPrincipal(cAPrinc.getName());
 232         }
 233 
 234         // XXX Compare name to credName
 235 
 236         if (sPrinc != null) {
 237             server =
 238                 new KerberosPrincipal(sPrinc.getName(),
 239                                         KerberosPrincipal.KRB_NT_SRV_INST);
 240         }
 241 
 242         if (sAPrinc != null) {
 243             serverAlias = new KerberosPrincipal(sAPrinc.getName());
 244         }
 245 
 246         return new Krb5InitCredential(credName,
 247                                       delegatedCred,
 248                                       delegatedCred.getEncoded(),
 249                                       client,
 250                                       clientAlias,
 251                                       server,
 252                                       serverAlias,
 253                                       sessionKey.getBytes(),
 254                                       sessionKey.getEType(),
 255                                       delegatedCred.getFlags(),
 256                                       delegatedCred.getAuthTime(),
 257                                       delegatedCred.getStartTime(),
 258                                       delegatedCred.getEndTime(),
 259                                       delegatedCred.getRenewTill(),
 260                                       delegatedCred.getClientAddresses());
 261     }
 262 
 263     /**
 264      * Returns the principal name for this credential. The name
 265      * is in mechanism specific format.
 266      *
 267      * @return GSSNameSpi representing principal name of this credential
 268      * @exception GSSException may be thrown
 269      */
 270     public final GSSNameSpi getName() throws GSSException {
 271         return name;
 272     }
 273 
 274     /**
 275      * Returns the init lifetime remaining.
 276      *
 277      * @return the init lifetime remaining in seconds
 278      * @exception GSSException may be thrown
 279      */
 280     public int getInitLifetime() throws GSSException {
 281         Date d = getEndTime();
 282         if (d == null) {
 283             return 0;
 284         }
 285         long retVal = d.getTime() - System.currentTimeMillis();
 286         return (int)(retVal/1000);
 287     }
 288 
 289     /**
 290      * Returns the accept lifetime remaining.
 291      *
 292      * @return the accept lifetime remaining in seconds
 293      * @exception GSSException may be thrown
 294      */
 295     public int getAcceptLifetime() throws GSSException {
 296         return 0;
 297     }
 298 
 299     public boolean isInitiatorCredential() throws GSSException {
 300         return true;
 301     }
 302 
 303     public boolean isAcceptorCredential() throws GSSException {
 304         return false;
 305     }
 306 
 307     /**
 308      * Returns the oid representing the underlying credential
 309      * mechanism oid.
 310      *
 311      * @return the Oid for this credential mechanism
 312      * @exception GSSException may be thrown
 313      */
 314     public final Oid getMechanism() {
 315         return Krb5MechFactory.GSS_KRB5_MECH_OID;
<a name="4" id="anc4"></a><span class="new"> 316     }</span>
<span class="new"> 317 </span>
<span class="new"> 318     /**</span>
<span class="new"> 319      * Returns true if the credential is a default credential.</span>
<span class="new"> 320      *</span>
<span class="new"> 321      * @return true if the credential is a default credential, else false.</span>
<span class="new"> 322      */</span>
<span class="new"> 323     public boolean isDefaultCredential() {</span>
<span class="new"> 324         return isDefCred;</span>
 325     }
 326 
 327     public final java.security.Provider getProvider() {
 328         return Krb5MechFactory.PROVIDER;
 329     }
 330 
 331 
 332     /**
 333      * Returns a sun.security.krb5.Credentials instance so that it maybe
 334      * used in that package for th Kerberos protocol.
 335      */
 336     Credentials getKrb5Credentials() {
 337         return krb5Credentials;
 338     }
 339 
 340     /*
 341      * XXX Call to this.refresh() should refresh the locally cached copy
 342      * of krb5Credentials also.
 343      */
 344 
 345     /**
 346      * Called to invalidate this credential element.
 347      */
 348     public void dispose() throws GSSException {
 349         try {
 350             destroy();
 351         } catch (javax.security.auth.DestroyFailedException e) {
 352             GSSException gssException =
 353                 new GSSException(GSSException.FAILURE, -1,
 354                  "Could not destroy credentials - " + e.getMessage());
 355             gssException.initCause(e);
 356         }
 357     }
 358 
 359     // XXX call to this.destroy() should destroy the locally cached copy
 360     // of krb5Credentials and then call super.destroy().
 361 
 362     private static KerberosTicket getTgt(GSSCaller caller, Krb5NameElement name,
 363                                                  int initLifetime)
 364         throws GSSException {
 365 
 366         final String clientPrincipal;
 367 
 368         /*
 369          * Find the TGT for the realm that the client is in. If the client
 370          * name is not available, then use the default realm.
 371          */
 372         if (name != null) {
 373             clientPrincipal = (name.getKrb5PrincipalName()).getName();
 374         } else {
 375             clientPrincipal = null;
 376         }
 377 
 378         final AccessControlContext acc = AccessController.getContext();
 379 
 380         try {
 381             final GSSCaller realCaller = (caller == GSSCaller.CALLER_UNKNOWN)
 382                                    ? GSSCaller.CALLER_INITIATE
 383                                    : caller;
 384             return AccessController.doPrivileged(
 385                 new PrivilegedExceptionAction&lt;KerberosTicket&gt;() {
 386                 public KerberosTicket run() throws Exception {
 387                     // It's OK to use null as serverPrincipal. TGT is almost
 388                     // the first ticket for a principal and we use list.
 389                     return Krb5Util.getInitialTicket(
 390                         realCaller,
 391                         clientPrincipal, acc);
 392                         }});
 393         } catch (PrivilegedActionException e) {
 394             GSSException ge =
 395                 new GSSException(GSSException.NO_CRED, -1,
 396                     "Attempt to obtain new INITIATE credentials failed!" +
 397                     " (" + e.getMessage() + ")");
 398             ge.initCause(e.getException());
 399             throw ge;
 400         }
 401     }
 402 
 403     @Override
 404     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
 405         try {
 406             Krb5NameElement kname = (Krb5NameElement)name;
 407             Credentials newCred = Credentials.acquireS4U2selfCreds(
 408                     kname.getKrb5PrincipalName(), krb5Credentials);
 409             return new Krb5ProxyCredential(this, kname, newCred.getTicket());
 410         } catch (IOException | KrbException ke) {
 411             GSSException ge =
 412                 new GSSException(GSSException.FAILURE, -1,
 413                     "Attempt to obtain S4U2self credentials failed!");
 414             ge.initCause(ke);
 415             throw ge;
 416         }
 417     }
 418 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="5" type="hidden"></input></form></body></html>
