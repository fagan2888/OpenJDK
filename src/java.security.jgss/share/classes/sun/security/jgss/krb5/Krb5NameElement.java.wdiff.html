<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>ws Wdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java</title>

    <meta http-equiv="cache-control" content="no-cache" />

    <style type='text/css' media='screen'>
      pre	{ margin: 2px; }

      body	{ background-color: #eeeeee; }

      hr	{ border: none 0; border-top: 1px solid #aaa; height: 1px; }

      .subtracted { color: brown }
      .added	{ color: blue }

      .elided	{ border: 1px solid #444; cursor: pointer; margin: 1px }

      table.hidebar { border: 1px solid #ff9900; background-color: #eee;
      		  text-align: center; border-collapse: collapse; }

      .hidebar td.active-down { border: 1px solid #ff9900;
		border-right: 1px solid #ccc; cursor: s-resize }

      .hidebar td.active-down:hover { background-color: #ffcc99; }

      .hidebar td.active-up { border: 1px solid #ff9900; cursor: n-resize;
		border-left: 1px solid #ccc; }

      .hidebar td.active-up:hover { background-color: #ffcc99; }

      .hidebar td.elided-label { font-style: italic; width: 12em; }

      .cmdbox	{ position: fixed; top: 0; right: 0;
	          border-left: solid 1px #444;
	          border-bottom: solid 1px #444;
      		  background-color: #ccc; text-align: center }

      .cmdbox td { background-color: #eee; border: 1px #444 outset;
		   cursor: pointer; padding: 3px 4px; }
      .cmdbox td:hover { background-color: #ffcc99;
 		outline: thin solid #ff9900; }

      a:hover { background-color: #ffcc99; }

      a.print { font-size: x-small; }
    </style>

    <style type='text/css' media='print'>
	pre { font-family: courier, monospace; font-size: 0.8em; }
	.cmdbox { display: none; }
        a.print { display: none; }
	.hidebar td.active-down { display: none; }
	.hidebar td.active-up { display: none; }
        .hidebar td.elided-label { font-style: italic; font-size: small; }
	table.hidebar { border: none; border-bottom: 1px dotted #000000; }
	span.added { font-weight: bold;
	         background-color: #eee; width: 100%; display: block; }
	span.subtracted { font-style: italic;
		 background-color: #eee; width: 100%; display: block; }
	.elided { display: none; }
        hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
    </style>

    <script type="text/javascript">
      function show_n_hide_dir(id_to_show, id_to_hide, dir) {
	      var elt_to_show = document.getElementById(id_to_show);
	      var elt_to_hide = document.getElementById(id_to_hide);
	      // When we're opening up, we need to make the bottoms of the
	      // elements appear to be the same.  So our invariant should be
	      // elt.offsetBottom - window.scrollY.
	      var preinvar = elt_to_hide.offsetHeight - window.scrollY;
	      elt_to_show.style.setProperty('display', '', '');
	      elt_to_hide.style.setProperty('display', 'none', '');
	      if (dir == 'up') {
		      var postinvar = elt_to_show.offsetHeight - window.scrollY;
		      window.scrollBy(0, postinvar - preinvar);
	      }
      }

      function handle_click(e) {
	      var eh = e.target;
	      var es = document.getElementById("hb-" + e.target.id);
	      eh.style.setProperty('display', 'none', '');
	      es.style.setProperty('display', '', '');
	      /* Scroll so new element is at cursor. */
	      window.scroll(0, es.offsetTop + (es.offsetHeight / 2)
	          - e.clientY);
      }

      function stripsearch(str) {
	q = str.indexOf("?");
	if (q != -1)
	  str = str.substr(0, q);
	return (str);
      }

      function split() {
        page = stripsearch(location.href);
	halfway = window.scrollY + window.innerHeight / 2 - 5;
	document.write('<frameset rows="50%,*">' +
	  '<frame src="' + page + "?" + window.scrollY + '" />' +
	  '<frame src="' + page + "?" + halfway + '" />' +
	  '</frameset>');
	document.close();
      }

      function closeframe() {
	page = stripsearch(location.href);

	otherf = window.parent.frames[0];
	if (otherf == window)
	  otherf = window.parent.frames[1];

	parent.location.replace(page + "?" + otherf.scrollY);
      }
    </script>
  </head>
  <body id='SUNWwebrev'>
    <a class="print" href="javascript:print()">Print this page</a>
    <pre>
Add isDefaultCredential() method to GSSCredentialSpi
Add getLocalName() GSSName method
</pre>
<hr />
    <table class='cmdbox'>
      <tr>
        <td onclick='split()'>Split</td>
	<td id='close' onclick='closeframe()'>Close</td>
      </tr>
      <tr><td colspan="2" onclick='open_or_close_all(1)'>Expand all</td></tr>
      <tr><td colspan="2" onclick='open_or_close_all(0)'>Collapse all</td></tr>
    </table>

    <script type='text/javascript'>
      if (window == top)
        document.getElementById('close').style.setProperty('display', 'none', '');
    </script>
<pre><span class='subtracted'>          --- old/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java
</span><span class='added'>          +++ new/src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5NameElement.java
</span></pre>
<pre id='elided1' class='elided' style='display: none'>   1    1  /*
   2    2   * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.
   3    3   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4    4   *
   5    5   * This code is free software; you can redistribute it and/or modify it
   6    6   * under the terms of the GNU General Public License version 2 only, as
   7    7   * published by the Free Software Foundation.  Oracle designates this
   8    8   * particular file as subject to the "Classpath" exception as provided
   9    9   * by Oracle in the LICENSE file that accompanied this code.
  10   10   *
  11   11   * This code is distributed in the hope that it will be useful, but WITHOUT
  12   12   * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13   13   * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14   14   * version 2 for more details (a copy is included in the LICENSE file that
  15   15   * accompanied this code).
  16   16   *
  17   17   * You should have received a copy of the GNU General Public License version
  18   18   * 2 along with this work; if not, write to the Free Software Foundation,
  19   19   * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20   20   *
  21   21   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22   22   * or visit www.oracle.com if you need additional information or have any
  23   23   * questions.
  24   24   */
  25   25  
  26   26  package sun.security.jgss.krb5;
  27   27  
  28   28  import org.ietf.jgss.*;
  29   29  import sun.security.jgss.spi.*;
  30   30  import sun.security.krb5.PrincipalName;
  31   31  import sun.security.krb5.Realm;
  32   32  import sun.security.krb5.KrbException;
  33   33  
  34   34  import javax.security.auth.kerberos.ServicePermission;
  35   35  import java.io.UnsupportedEncodingException;
  36   36  import java.net.InetAddress;
  37   37  import java.net.UnknownHostException;
  38   38  import java.security.Provider;
  39   39  import java.util.Locale;
  40   40  
  41   41  /**
  42   42   * Implements the GSSNameSpi for the krb5 mechanism.
  43   43   *
  44   44   * @author Mayank Upadhyay
  45   45   */
  46   46  public class Krb5NameElement
  47   47      implements GSSNameSpi {
  48   48  
  49   49      private PrincipalName krb5PrincipalName;
  50   50  
  51   51      private String gssNameStr = null;
  52   52      private Oid gssNameType = null;
  53   53  
  54   54      // XXX Move this concept into PrincipalName's asn1Encode() sometime
  55   55      private static String CHAR_ENCODING = "UTF-8";
  56   56  
  57   57      private Krb5NameElement(PrincipalName principalName,
  58   58                              String gssNameStr,
  59   59                              Oid gssNameType) {
  60   60          this.krb5PrincipalName = principalName;
  61   61          this.gssNameStr = gssNameStr;
  62   62          this.gssNameType = gssNameType;
  63   63      }
  64   64  
  65   65      /**
  66   66       * Instantiates a new Krb5NameElement object. Internally it stores the
  67   67       * information provided by the input parameters so that they may later
  68   68       * be used for output when a printable representaion of this name is
  69   69       * needed in GSS-API format rather than in Kerberos format.
  70   70       *
  71   71       */
  72   72      static Krb5NameElement getInstance(String gssNameStr, Oid gssNameType)
  73   73          throws GSSException {
  74   74  
  75   75          /*
  76   76           * A null gssNameType implies that the mechanism default
  77   77           * Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL be used.
  78   78           */
  79   79          if (gssNameType == null)
  80   80              gssNameType = Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL;
  81   81          else
  82   82              if (!gssNameType.equals(GSSName.NT_USER_NAME) &amp;&amp;
  83   83                  !gssNameType.equals(GSSName.NT_HOSTBASED_SERVICE) &amp;&amp;
  84   84                  !gssNameType.equals(Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL) &amp;&amp;
  85   85                  !gssNameType.equals(GSSName.NT_EXPORT_NAME))
  86   86                  throw new GSSException(GSSException.BAD_NAMETYPE, -1,
  87   87                                         gssNameType.toString()
  88   88                                         +" is an unsupported nametype");
  89   89  
  90   90          PrincipalName principalName;
  91   91          try {
  92   92  
  93   93              if (gssNameType.equals(GSSName.NT_EXPORT_NAME) ||
  94   94                  gssNameType.equals(Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL)) {
  95   95                  principalName = new PrincipalName(gssNameStr,
  96   96                                    PrincipalName.KRB_NT_PRINCIPAL);
  97   97              } else {
  98   98  
  99   99                  String[] components = getComponents(gssNameStr);
 100  100  
 101  101                  /*
 102  102                   * We have forms of GSS name strings that can come in:
 103  103                   *
 104  104                   * 1. names of the form "foo" with just one
 105  105                   * component. (This might include a "@" but only in escaped
 106  106                   * form like "\@")
 107  107                   * 2. names of the form "foo@bar" with two components
 108  108                   *
 109  109                   * The nametypes that are accepted are NT_USER_NAME, and
 110  110                   * NT_HOSTBASED_SERVICE.
 111  111                   */
 112  112  
 113  113                  if (gssNameType.equals(GSSName.NT_USER_NAME))
 114  114                      principalName = new PrincipalName(gssNameStr,
 115  115                                      PrincipalName.KRB_NT_PRINCIPAL);
 116  116                  else {
 117  117                      String hostName = null;
 118  118                      String service = components[0];
 119  119                      if (components.length &gt;= 2)
 120  120                          hostName = components[1];
 121  121  
 122  122                      String principal = getHostBasedInstance(service, hostName);
 123  123                      principalName = new PrincipalName(principal,
 124  124                              PrincipalName.KRB_NT_SRV_HST);
 125  125                  }
 126  126              }
 127  127  
 128  128          } catch (KrbException e) {
 129  129              throw new GSSException(GSSException.BAD_NAME, -1, e.getMessage());
 130  130          }
 131  131  
 132  132          if (principalName.isRealmDeduced() &amp;&amp; !Realm.AUTODEDUCEREALM) {
 133  133              SecurityManager sm = System.getSecurityManager();
 134  134              if (sm != null) {
 135  135                  try {
 136  136                      sm.checkPermission(new ServicePermission(
 137  137                              "@" + principalName.getRealmAsString(), "-"));
 138  138                  } catch (SecurityException se) {
 139  139                      // Do not chain the actual exception to hide info
 140  140                      throw new GSSException(GSSException.FAILURE);
 141  141                  }
 142  142              }
 143  143          }
 144  144          return new Krb5NameElement(principalName, gssNameStr, gssNameType);
 145  145      }
 146  146  
 147  147      public static Krb5NameElement getInstance(PrincipalName principalName) {
 148  148          return new Krb5NameElement(principalName,
 149  149                                     principalName.getName(),
 150  150                                     Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
 151  151      }
 152  152  
 153  153      private static String[] getComponents(String gssNameStr)
 154  154          throws GSSException {
 155  155  
 156  156          String[] retVal;
 157  157  
 158  158          // XXX Perhaps provide this parsing code in PrincipalName
 159  159  
 160  160          // Look for @ as in service@host
 161  161          // Assumes host name will not have an escaped '@'
 162  162          int separatorPos = gssNameStr.lastIndexOf('@', gssNameStr.length());
 163  163  
 164  164          // Not really a separator if it is escaped. Then this is just part
 165  165          // of the principal name or service name
 166  166          if ((separatorPos &gt; 0) &amp;&amp;
 167  167                  (gssNameStr.charAt(separatorPos-1) == '\\')) {
 168  168              // Is the `\` character escaped itself?
 169  169              if ((separatorPos - 2 &lt; 0) ||
 170  170                  (gssNameStr.charAt(separatorPos-2) != '\\'))
 171  171                  separatorPos = -1;
 172  172          }
 173  173  
 174  174          if (separatorPos &gt; 0) {
 175  175              String serviceName = gssNameStr.substring(0, separatorPos);
 176  176              String hostName = gssNameStr.substring(separatorPos+1);
 177  177              retVal = new String[] { serviceName, hostName};
 178  178          } else {
 179  179              retVal = new String[] {gssNameStr};
 180  180          }
 181  181  
 182  182          return retVal;
 183  183  
 184  184      }
 185  185  
 186  186      private static String getHostBasedInstance(String serviceName,
 187  187                                                 String hostName)
 188  188          throws GSSException {
 189  189              StringBuffer temp = new StringBuffer(serviceName);
 190  190  
 191  191              try {
 192  192                  // A lack of "@" defaults to the service being on the local
 193  193                  // host as per RFC 2743
 194  194                  // XXX Move this part into JGSS framework
 195  195                  if (hostName == null)
 196  196                      hostName = InetAddress.getLocalHost().getHostName();
 197  197  
 198  198              } catch (UnknownHostException e) {
 199  199                  // use hostname as it is
 200  200              }
 201  201              hostName = hostName.toLowerCase(Locale.ENGLISH);
 202  202  
 203  203              temp = temp.append('/').append(hostName);
 204  204              return temp.toString();
 205  205      }
 206  206  
 207  207      public final PrincipalName getKrb5PrincipalName() {
 208  208          return krb5PrincipalName;
 209  209      }
 210  210  
 211  211      /**
 212  212       * Equal method for the GSSNameSpi objects.
 213  213       * If either name denotes an anonymous principal, the call should
 214  214       * return false.
 215  215       *
 216  216       * @param other to be compared with
 217  217       * @return true if they both refer to the same entity, else false
 218  218       * @exception GSSException with major codes of BAD_NAMETYPE,
 219  219       *  BAD_NAME, FAILURE
 220  220       */
 221  221      public boolean equals(GSSNameSpi other) throws GSSException {
 222  222  
 223  223          if (other == this)
 224  224              return true;
 225  225  
 226  226          if (other instanceof Krb5NameElement) {
 227  227                  Krb5NameElement that = (Krb5NameElement) other;
 228  228                  return (this.krb5PrincipalName.getName().equals(
 229  229                              that.krb5PrincipalName.getName()));
 230  230          }
 231  231          return false;
 232  232      }
 233  233  
 234  234      /**
 235  235       * Compares this &lt;code&gt;GSSNameSpi&lt;/code&gt; object to another Object
 236  236       * that might be a &lt;code&gt;GSSNameSpi&lt;/code&gt;. The behaviour is exactly
 237  237       * the same as in {@link #equals(GSSNameSpi) equals} except that
 238  238       * no GSSException is thrown; instead, false will be returned in the
 239  239       * situation where an error occurs.
 240  240       *
 241  241       * @param another the object to be compared to
 242  242       * @return true if they both refer to the same entity, else false
 243  243       * @see #equals(GSSNameSpi)
 244  244       */
 245  245      public boolean equals(Object another) {
 246  246          if (this == another) {
 247  247              return true;
 248  248          }
 249  249  
 250  250          try {
 251  251              if (another instanceof Krb5NameElement)
 252  252                   return equals((Krb5NameElement) another);
 253  253          } catch (GSSException e) {
 254  254              // ignore exception
 255  255          }
 256  256          return false;
 257  257      }
 258  258  
 259  259      /**
 260  260       * Returns a hashcode value for this GSSNameSpi.
 261  261       *
 262  262       * @return a hashCode value
 263  263       */
 264  264      public int hashCode() {
 265  265          return 37 * 17 + krb5PrincipalName.getName().hashCode();
 266  266      }
 267  267  
 268  268  
 269  269      /**
 270  270       * Returns the principal name in the form user@REALM or
 271  271       * host/service@REALM but with the following constraints that are
 272  272       * imposed by RFC 1964:
 273  273       * &lt;pre&gt;
 274  274       *  (1) all occurrences of the characters `@`,  `/`, and `\` within
 275  275       *   principal components or realm names shall be quoted with an
 276  276       *   immediately-preceding `\`.
 277  277       *
 278  278       *   (2) all occurrences of the null, backspace, tab, or newline
 279  279       *   characters within principal components or realm names will be
 280  280       *   represented, respectively, with `\0`, `\b`, `\t`, or `\n`.
 281  281       *
 282  282       *   (3) the `\` quoting character shall not be emitted within an
 283  283       *   exported name except to accommodate cases (1) and (2).
 284  284       * &lt;/pre&gt;
 285  285       */
 286  286      public byte[] export() throws GSSException {
 287  287          // XXX Apply the above constraints.
 288  288          byte[] retVal = null;
 289  289          try {
 290  290              retVal = krb5PrincipalName.getName().getBytes(CHAR_ENCODING);
 291  291          } catch (UnsupportedEncodingException e) {
 292  292              // Can't happen
 293  293          }
 294  294          return retVal;
 295  295      }
 296  296  
 297  297      /**
 298  298       * Get the mechanism type that this NameElement corresponds to.
 299  299       *
 300  300       * @return the Oid of the mechanism type
 301  301       */
 302  302      public Oid getMechanism() {
 303  303          return (Krb5MechFactory.GSS_KRB5_MECH_OID);
 304  304      }
 305  305  
 306  306      /**
 307  307       * Returns a string representation for this name. The printed
 308  308       * name type can be obtained by calling getStringNameType().
 309  309       *
</pre>
<table id='hb-elided1' class='hidebar'>
  <tr>
    <td class='active-down'
      onclick='show_n_hide_dir("elided1", "hb-elided1", "down")'>
      &darr;&nbsp;open down&nbsp;&darr;</td>
    <td class="elided-label">309 lines elided</td>
    <td class='active-up'
      onclick='show_n_hide_dir("elided1", "hb-elided1", "up")'>
      &uarr;&nbsp;open up&nbsp;&uarr;</td>
  </tr>
</table>
<pre> 310  310       * @return string form of this name
 311  311       * @see #getStringNameType()
 312  312       * @overrides Object#toString
 313  313       */
 314  314      public String toString() {
 315  315          return (gssNameStr);
 316  316          // For testing: return (super.toString());
 317  317      }
 318  318  
 319  319      /**
<span class='added'>      320 +     * Returns a local username (platform-specific) corresponding to the
      321 +     * principal name, and may return null when no username is known for the
      322 +     * principal name.
      323 +     *
      324 +     * @return username corresponding to this principal name, if any
      325 +     */
      326 +    public String getLocalName() throws GSSException {
      327 +        throw new GSSException(GSSException.UNAVAILABLE, -1,
      328 +                "Mapping Kerberos principal names to usernames is not " +
      329 +                "currently supported");
      330 +    }
      331 +
      332 +    /**
      333 +     * Returns a local username (platform-specific) corresponding to the
      334 +     * principal name, and may return null when no username is known for the
      335 +     * principal name.
      336 +     *
      337 +     * @return username corresponding to this principal name, if any
      338 +     */
      339 +    public String getLocalName(Oid mech) throws GSSException {
      340 +        throw new GSSException(GSSException.UNAVAILABLE, -1,
      341 +                "Mapping Kerberos principal names to usernames is not " +
      342 +                "currently supported");
      343 +    }
      344 +
      345 +    /**
</span> 320  346       * Returns the name type oid.
 321  347       */
 322  348      public Oid getGSSNameType() {
 323  349          return (gssNameType);
 324  350      }
 325  351  
 326  352      /**
 327  353       * Returns the oid describing the format of the printable name.
 328  354       *
 329  355       * @return the Oid for the format of the printed name
</pre>
<pre id='elided2' class='elided' style='display: none'> 330  356       */
 331  357      public Oid getStringNameType() {
</pre>
<table id='hb-elided2' class='hidebar'>
  <tr>
    <td class='active-down'
      onclick='show_n_hide_dir("elided2", "hb-elided2", "down")'>
      &darr;&nbsp;open down&nbsp;&darr;</td>
    <td class="elided-label">2 lines elided</td>
    <td class='active-up'
      onclick='show_n_hide_dir("elided2", "hb-elided2", "up")'>
      &uarr;&nbsp;open up&nbsp;&uarr;</td>
  </tr>
</table>
<pre> 332  358          // XXX For NT_EXPORT_NAME return a different name type. Infact,
 333  359          // don't even store NT_EXPORT_NAME in the cons.
 334  360          return (gssNameType);
 335  361      }
 336  362  
 337  363      /**
 338  364       * Indicates if this name object represents an Anonymous name.
 339  365       */
 340  366      public boolean isAnonymousName() {
 341  367          return (gssNameType.equals(GSSName.NT_ANONYMOUS));
<span class='added'>      368 +    }
      369 +
      370 +    public boolean isDefaultCredentialName() {
      371 +        return false;
</span> 342  372      }
 343  373  
 344  374      public Provider getProvider() {
 345  375          return Krb5MechFactory.PROVIDER;
 346  376      }
 347  377  
 348  378  }
    </pre>
<pre id='linerefpre'><span id='lineref'>XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></pre>
    <br clear="all" />
    <br />

    <script type="text/javascript">
      /* Assign event handlers and widths. */
      var w = document.getElementById('lineref').offsetWidth;
      for (var i = 1; i <= 2; ++i) {
	      var e = document.getElementById("elided" + i);
	      e.onclick = handle_click;
              e.style.setProperty('width', w + "px", '');

	      e = document.getElementById("hb-elided" + i);
              e.style.setProperty('width', w + "px", '');
      }

      /* Hide our line size reference. */
      document.getElementById('linerefpre').style.setProperty('display',
          'none', '');

      /* Scroll as indicated. */
      str = location.search;
      s = str.substring(1, str.length);
      if (s > 0)
        window.scroll(0, s);

      function open_or_close_all(open) {
	      for (var i = 1; i <= 2; ++i) {
		      var e = document.getElementById("hb-elided" + i);
		      e.style.setProperty("display", open ? "none" : "", "");

		      e = document.getElementById("elided" + i);
		      e.style.setProperty("display", open ? "" : "none", "");
	      }
      }
    </script>
  </body>
</html>
