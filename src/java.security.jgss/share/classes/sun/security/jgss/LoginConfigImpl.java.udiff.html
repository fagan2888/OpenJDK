<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Udiff src/java.security.jgss/share/classes/sun/security/jgss/LoginConfigImpl.java</title>

<style type="text/css" media="screen">
span.new {
    color: blue;
    font-weight: normal;
}
</style>

</head>
<body id="SUNWwebrev">
        <a class="print" href="javascript:print()">Print this page</a>
<pre>Engage GssLoginModule (only) when native=true
Also don't force same name for acceptor and initiator.
Add GssLoginModule
This module is to be used for GSS applications in preference to
Krb5LoginModule, especially when using the native GSS provider.</pre>
        <pre>
</pre><hr></hr><pre>
<span class="newmarker">@@ -40,10 +40,11 @@</span>
 public class LoginConfigImpl extends Configuration {
 
     private final Configuration config;
     private final GSSCaller caller;
     private final String mechName;
<span class="new">+    private final boolean useNative;</span>
     private static final sun.security.util.Debug debug =
         sun.security.util.Debug.getInstance("gssloginconfig", "\t[GSS LoginConfigImpl]");
 
     public static final boolean HTTP_USE_GLOBAL_CREDS;
 
</pre><hr></hr><pre>
<span class="newmarker">@@ -63,12 +64,21 @@</span>
      */
     public LoginConfigImpl(GSSCaller caller, Oid mech) {
 
         this.caller = caller;
 
<span class="removed">-        if (mech.equals(GSSUtil.GSS_KRB5_MECH_OID)) {</span>
<span class="new">+        useNative = "true".equalsIgnoreCase(</span>
<span class="new">+                System.getProperty("sun.security.jgss.native"));</span>
<span class="new">+</span>
<span class="new">+        if (mech.equals(GSSUtil.GSS_KRB5_MECH_OID) ||</span>
<span class="new">+                mech.equals(GSSUtil.GSS_KRB5_MECH_OID2) ||</span>
<span class="new">+                mech.equals(GSSUtil.GSS_KRB5_MECH_OID_MS)) {</span>
             mechName = "krb5";
<span class="new">+        } else if (useNative) {</span>
<span class="new">+            // We don't really need a mechName, nor do we have any sort of</span>
<span class="new">+            // standard notion of mechanism name (other than OIDs).</span>
<span class="new">+            mechName = mech.toString();</span>
         } else {
             throw new IllegalArgumentException(mech.toString() + " not supported");
         }
         config = java.security.AccessController.doPrivileged
                 (new java.security.PrivilegedAction &lt;Configuration&gt; () {
</pre><hr></hr><pre>
<span class="newmarker">@@ -96,11 +106,11 @@</span>
 
         // Compatibility:
         // For the 4 old callers, old entry names will be used if the new
         // entry name is not provided.
 
<span class="removed">-        if ("krb5".equals(mechName)) {</span>
<span class="new">+        if ("krb5".equals(mechName) || useNative) {</span>
             if (caller == GSSCaller.CALLER_INITIATE) {
                 alts = new String[] {
                     "com.sun.security.jgss.krb5.initiate",
                     "com.sun.security.jgss.initiate",
                 };
</pre><hr></hr><pre>
<span class="newmarker">@@ -116,11 +126,11 @@</span>
             } else if (caller == GSSCaller.CALLER_UNKNOWN) {
                 throw new AssertionError("caller not defined");
             }
         } else {
             throw new IllegalArgumentException(mechName + " not supported");
<span class="removed">-            // No other mech at the moment, maybe --</span>
<span class="new">+            // No other Java-coded mech at the moment, maybe --</span>
             /*
             switch (caller) {
             case GSSUtil.CALLER_INITIATE:
             case GSSUtil.CALLER_HTTP_NEGOTIATE:
                 alts = new String[] {
</pre><hr></hr><pre>
<span class="newmarker">@@ -163,34 +173,46 @@</span>
     /**
      * Default value for a caller-mech pair when no entry is defined in
      * the system-wide Configuration object.
      */
     private AppConfigurationEntry[] getDefaultConfigurationEntry() {
<span class="removed">-        HashMap &lt;String, String&gt; options = new HashMap &lt;String, String&gt; (2);</span>
<span class="new">+        HashMap &lt;String, String&gt; gssOptions = new HashMap &lt;String, String&gt; (2);</span>
<span class="new">+        HashMap &lt;String, String&gt; krb5Options = new HashMap &lt;String, String&gt; (2);</span>
 
<span class="removed">-        if (mechName == null || mechName.equals("krb5")) {</span>
<span class="new">+        if (mechName == null || mechName.equals("krb5") || useNative) {</span>
             if (isServerSide(caller)) {
<span class="new">+                gssOptions.put("useDefaultCreds", "true");</span>
<span class="new">+                gssOptions.put("doNotPrompt", "true");</span>
<span class="new">+                gssOptions.put("accept", "true");</span>
                 // Assuming the keytab file can be found through
                 // krb5 config file or under user home directory
<span class="removed">-                options.put("useKeyTab", "true");</span>
<span class="removed">-                options.put("storeKey", "true");</span>
<span class="removed">-                options.put("doNotPrompt", "true");</span>
<span class="removed">-                options.put("principal", "*");</span>
<span class="removed">-                options.put("isInitiator", "false");</span>
<span class="new">+                krb5Options.put("useKeyTab", "true");</span>
<span class="new">+                krb5Options.put("storeKey", "true");</span>
<span class="new">+                krb5Options.put("doNotPrompt", "true");</span>
<span class="new">+                krb5Options.put("principal", "*");</span>
<span class="new">+                krb5Options.put("isInitiator", "false");</span>
             } else {
                 if (caller instanceof HttpCaller &amp;&amp; !HTTP_USE_GLOBAL_CREDS) {
<span class="removed">-                    options.put("useTicketCache", "false");</span>
<span class="new">+                    gssOptions.put("tryDefaultCreds", "false");</span>
<span class="new">+                    krb5Options.put("useTicketCache", "false");</span>
                 } else {
<span class="removed">-                    options.put("useTicketCache", "true");</span>
<span class="new">+                    gssOptions.put("tryDefaultCreds", "true");</span>
<span class="new">+                    krb5Options.put("useTicketCache", "true");</span>
                 }
<span class="removed">-                options.put("doNotPrompt", "false");</span>
<span class="new">+                gssOptions.put("initiate", "true");</span>
<span class="new">+                gssOptions.put("doNotPrompt", "false");</span>
<span class="new">+                krb5Options.put("doNotPrompt", "false");</span>
             }
             return new AppConfigurationEntry[] {
                 new AppConfigurationEntry(
<span class="removed">-                        "com.sun.security.auth.module.Krb5LoginModule",</span>
<span class="new">+                        "com.sun.security.auth.module.GssLoginModule",</span>
                         AppConfigurationEntry.LoginModuleControlFlag.REQUIRED,
<span class="removed">-                        options)</span>
<span class="new">+                        gssOptions),</span>
<span class="new">+                new AppConfigurationEntry(</span>
<span class="new">+                        "com.sun.security.auth.module.Krb5LoginModule",</span>
<span class="new">+                        AppConfigurationEntry.LoginModuleControlFlag.SUFFICIENT,</span>
<span class="new">+                        krb5Options)</span>
             };
         }
         return null;
     }
 
</pre></body></html>

