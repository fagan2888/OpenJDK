<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Sdiff src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSLibStub.java</title>
</head><body id="SUNWwebrev">
<a class="print" href="javascript:print()">Print this page</a>
<pre>Add JGSS JNI bindings for gss cred store functions
Add createCredential() with password
Also avoid memory allocation in newGSSOIDSet() renamed to makeGSSOIDset()
which now takes a singleton set argument and either assigns the requested
OID or with SPNEGO returns a static list of all the supported mechs. With
this we no longer need deleteGSSOIDSet().
Add getLocalName() GSSName method</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.wrapper;
  27 


  28 import java.util.Hashtable;
  29 import org.ietf.jgss.Oid;
  30 import org.ietf.jgss.GSSName;
  31 import org.ietf.jgss.ChannelBinding;
  32 import org.ietf.jgss.MessageProp;
  33 import org.ietf.jgss.GSSException;
  34 import sun.security.jgss.GSSUtil;
  35 
  36 /**
  37  * This class is essentially a JNI calling stub for all wrapper classes.
  38  *
  39  * @author Valerie Peng
  40  * @since 1.6
  41  */
  42 
  43 class GSSLibStub {
  44 
  45     private Oid mech;
  46     private long pMech;
  47 
  48     /**
  49      * Initialization routine to dynamically load function pointers.
  50      *
  51      * @param lib library name to dlopen
  52      * @param debug set to true for reporting native debugging info
  53      * @return true if succeeded, false otherwise.
  54      */
  55     static native boolean init(String lib, boolean debug);
  56     private static native long getMechPtr(byte[] oidDerEncoding);
  57 
  58     // Miscellaneous routines
  59     static native Oid[] indicateMechs();
  60     native Oid[] inquireNamesForMech() throws GSSException;
  61 
  62     // Name related routines
  63     native void releaseName(long pName);
  64     native long importName(byte[] name, Oid type);
  65     native boolean compareName(long pName1, long pName2);
  66     native long canonicalizeName(long pName);
  67     native byte[] exportName(long pName) throws GSSException;

  68     native Object[] displayName(long pName) throws GSSException;
  69 
  70     // Credential related routines
<span class="changed">  71     native long acquireCred(long pName, int lifetime, int usage)</span>
<span class="changed">  72                                         throws GSSException;</span>



  73     native long releaseCred(long pCred);
  74     native long getCredName(long pCred);
  75     native int getCredTime(long pCred);
  76     native int getCredUsage(long pCred);
  77 
  78     // Context related routines
  79     native NativeGSSContext importContext(byte[] interProcToken);
  80     native byte[] initContext(long pCred, long targetName, ChannelBinding cb,
  81                               byte[] inToken, NativeGSSContext context);
  82     native byte[] acceptContext(long pCred, ChannelBinding cb,
  83                                 byte[] inToken, NativeGSSContext context);
  84     native long[] inquireContext(long pContext);
  85     native Oid getContextMech(long pContext);
  86     native long getContextName(long pContext, boolean isSrc);
  87     native int getContextTime(long pContext);
  88     native long deleteContext(long pContext);
  89     native int wrapSizeLimit(long pContext, int flags, int qop, int outSize);
  90     native byte[] exportContext(long pContext);
  91     native byte[] getMic(long pContext, int qop, byte[] msg);
  92     native void verifyMic(long pContext, byte[] token, byte[] msg,
  93                           MessageProp prop) ;
  94     native byte[] wrap(long pContext, byte[] msg, MessageProp prop);
  95     native byte[] unwrap(long pContext, byte[] msgToken, MessageProp prop);
  96 
  97     private static Hashtable&lt;Oid, GSSLibStub&gt;
  98         table = new Hashtable&lt;Oid, GSSLibStub&gt;(5);
  99 
 100     static GSSLibStub getInstance(Oid mech) throws GSSException {
 101         GSSLibStub s = table.get(mech);
 102         if (s == null) {
 103             s = new GSSLibStub(mech);
 104             table.put(mech, s);
 105         }
 106         return s;
 107     }
 108     private GSSLibStub(Oid mech) throws GSSException {
 109         SunNativeProvider.debug("Created GSSLibStub for mech " + mech);
 110         this.mech = mech;
 111         this.pMech = getMechPtr(mech.getDER());





















 112     }
 113     public boolean equals(Object obj) {
 114         if (obj == this) return true;
 115         if (!(obj instanceof GSSLibStub)) {
 116             return false;
 117         }
 118         return (mech.equals(((GSSLibStub) obj).getMech()));
 119     }
 120     public int hashCode() {
 121         return mech.hashCode();
 122     }
 123     Oid getMech() {
 124         return mech;
 125     }
 126 }
</pre></td><td><pre>

</pre><hr></hr><pre>
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.wrapper;
  27 
<span class="new">  28 import java.util.Map;</span>
<span class="new">  29 import java.util.ArrayList;</span>
  30 import java.util.Hashtable;
  31 import org.ietf.jgss.Oid;
  32 import org.ietf.jgss.GSSName;
  33 import org.ietf.jgss.ChannelBinding;
  34 import org.ietf.jgss.MessageProp;
  35 import org.ietf.jgss.GSSException;
  36 import sun.security.jgss.GSSUtil;
  37 
  38 /**
  39  * This class is essentially a JNI calling stub for all wrapper classes.
  40  *
  41  * @author Valerie Peng
  42  * @since 1.6
  43  */
  44 
  45 class GSSLibStub {
  46 
  47     private Oid mech;
  48     private long pMech;
  49 
  50     /**
  51      * Initialization routine to dynamically load function pointers.
  52      *
  53      * @param lib library name to dlopen
  54      * @param debug set to true for reporting native debugging info
  55      * @return true if succeeded, false otherwise.
  56      */
  57     static native boolean init(String lib, boolean debug);
  58     private static native long getMechPtr(byte[] oidDerEncoding);
  59 
  60     // Miscellaneous routines
  61     static native Oid[] indicateMechs();
  62     native Oid[] inquireNamesForMech() throws GSSException;
  63 
  64     // Name related routines
  65     native void releaseName(long pName);
  66     native long importName(byte[] name, Oid type);
  67     native boolean compareName(long pName1, long pName2);
  68     native long canonicalizeName(long pName);
  69     native byte[] exportName(long pName) throws GSSException;
<span class="new">  70     native String localName(long pName, Oid mech) throws GSSException;</span>
  71     native Object[] displayName(long pName) throws GSSException;
  72 
  73     // Credential related routines
<span class="changed">  74     native long acquireCred(long pName, String password, String[] store,</span>
<span class="changed">  75                             int lifetime, int usage) throws GSSException;</span>
<span class="changed">  76     native long storeCred(long pCred, int usage, Oid mech,</span>
<span class="changed">  77                           boolean overwrite, boolean defaultCred,</span>
<span class="changed">  78                           String[] store) throws GSSException;</span>
  79     native long releaseCred(long pCred);
  80     native long getCredName(long pCred);
  81     native int getCredTime(long pCred);
  82     native int getCredUsage(long pCred);
  83 
  84     // Context related routines
  85     native NativeGSSContext importContext(byte[] interProcToken);
  86     native byte[] initContext(long pCred, long targetName, ChannelBinding cb,
  87                               byte[] inToken, NativeGSSContext context);
  88     native byte[] acceptContext(long pCred, ChannelBinding cb,
  89                                 byte[] inToken, NativeGSSContext context);
  90     native long[] inquireContext(long pContext);
  91     native Oid getContextMech(long pContext);
  92     native long getContextName(long pContext, boolean isSrc);
  93     native int getContextTime(long pContext);
  94     native long deleteContext(long pContext);
  95     native int wrapSizeLimit(long pContext, int flags, int qop, int outSize);
  96     native byte[] exportContext(long pContext);
  97     native byte[] getMic(long pContext, int qop, byte[] msg);
  98     native void verifyMic(long pContext, byte[] token, byte[] msg,
  99                           MessageProp prop) ;
 100     native byte[] wrap(long pContext, byte[] msg, MessageProp prop);
 101     native byte[] unwrap(long pContext, byte[] msgToken, MessageProp prop);
 102 
 103     private static Hashtable&lt;Oid, GSSLibStub&gt;
 104         table = new Hashtable&lt;Oid, GSSLibStub&gt;(5);
 105 
 106     static GSSLibStub getInstance(Oid mech) throws GSSException {
 107         GSSLibStub s = table.get(mech);
 108         if (s == null) {
 109             s = new GSSLibStub(mech);
 110             table.put(mech, s);
 111         }
 112         return s;
 113     }
 114     private GSSLibStub(Oid mech) throws GSSException {
 115         SunNativeProvider.debug("Created GSSLibStub for mech " + mech);
 116         this.mech = mech;
 117         this.pMech = getMechPtr(mech.getDER());
<span class="new"> 118     }</span>
<span class="new"> 119     private static String[] map2array(Map&lt;String,String&gt; m) {</span>
<span class="new"> 120         if (m == null)</span>
<span class="new"> 121             return null;</span>
<span class="new"> 122         ArrayList&lt;String&gt; l = new ArrayList&lt;String&gt;();</span>
<span class="new"> 123         for (var e : m.entrySet()) {</span>
<span class="new"> 124             l.add(e.getKey());</span>
<span class="new"> 125             l.add(e.getValue());</span>
<span class="new"> 126         }</span>
<span class="new"> 127         return l.toArray(new String[0]);</span>
<span class="new"> 128     }</span>
<span class="new"> 129     public long acquireCred(long pName, String password,</span>
<span class="new"> 130                             Map&lt;String,String&gt; store,</span>
<span class="new"> 131                             int lifetime, int usage) throws GSSException {</span>
<span class="new"> 132         return acquireCred(pName, password, map2array(store), lifetime, usage);</span>
<span class="new"> 133     }</span>
<span class="new"> 134     public long storeCred(long pCred, int usage, Oid mech,</span>
<span class="new"> 135                           boolean overwrite, boolean defaultCred,</span>
<span class="new"> 136                           Map&lt;String,String&gt; store) throws GSSException {</span>
<span class="new"> 137         return storeCred(pCred, usage, mech, overwrite, defaultCred,</span>
<span class="new"> 138             map2array(store));</span>
 139     }
 140     public boolean equals(Object obj) {
 141         if (obj == this) return true;
 142         if (!(obj instanceof GSSLibStub)) {
 143             return false;
 144         }
 145         return (mech.equals(((GSSLibStub) obj).getMech()));
 146     }
 147     public int hashCode() {
 148         return mech.hashCode();
 149     }
 150     Oid getMech() {
 151         return mech;
 152     }
 153 }
</pre></td>
</tr></table>
</body></html>
