<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws New src/java.security.jgss/share/classes/sun/security/jgss/wrapper/GSSCredElement.java</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 2005, 2017, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package sun.security.jgss.wrapper;
  26 
  27 import org.ietf.jgss.*;
  28 import java.security.Provider;
  29 import java.util.Map;
  30 import java.util.List;
  31 import java.util.ArrayList;
  32 import sun.security.jgss.GSSUtil;
  33 import sun.security.jgss.spi.GSSCredentialSpi;
  34 import sun.security.jgss.spi.GSSNameSpi;
  35 
  36 /**
  37  * This class is essentially a wrapper class for the gss_cred_id_t
  38  * structure of the native GSS library.
  39  * @author Valerie Peng
  40  * @since 1.6
  41  */
  42 public class GSSCredElement implements GSSCredentialSpi {
  43 
  44     private int usage;
  45     long pCred; // Pointer to the gss_cred_id_t structure
  46     private GSSNameElement name = null;
  47     private GSSLibStub cStub;
  48     public boolean isDefCred;
  49 
  50     // Perform the necessary ServicePermission check on this cred
  51     // FIXME Don't use any Krb5-specific code here.
  52     void doServicePermCheck() throws GSSException {
  53         // FIXME We need only do this check in initSecContext() and
  54         // acceptSecContext(), so gut this here, and never ever do the
  55         // Krb5Util.getTGSName(name) check.
  56         if (GSSUtil.isKerberosMech(cStub.getMech())) {
  57             if (System.getSecurityManager() != null) {
  58                 if (isInitiatorCredential()) {
  59                     String tgsName = Krb5Util.getTGSName(name);
  60                     Krb5Util.checkServicePermission(tgsName, "initiate");
  61                 }
  62                 if (isAcceptorCredential() &amp;&amp;
  63                     name != GSSNameElement.DEF_ACCEPTOR) {
  64                     String krbName = name.getKrbName();
  65                     Krb5Util.checkServicePermission(krbName, "accept");
  66                 }
  67             }
  68         }
  69     }
  70 
  71     // Construct delegation cred using the actual context mech and srcName
  72     GSSCredElement(long pCredentials, GSSNameElement srcName, Oid mech)
  73         throws GSSException {
  74         pCred = pCredentials;
  75         cStub = GSSLibStub.getInstance(mech);
  76         usage = GSSCredential.INITIATE_ONLY;
  77         name = srcName;
  78     }
  79 
  80     private GSSCredElement(GSSNameElement name, String password,
  81                            Map&lt;String,String&gt; store, int lifetime, int usage,
  82                            GSSLibStub stub) throws GSSException {
  83         cStub = stub;
  84         this.usage = usage;
  85 
  86         if (name != null) { // Could be GSSNameElement.DEF_ACCEPTOR
  87             this.name = name;
  88             doServicePermCheck();
  89             pCred = cStub.acquireCred(this.name.pName, password, store,
  90                 lifetime, usage);
  91             if (name == GSSNameElement.DEF_ACCEPTOR)
  92                 isDefCred = true;
  93         } else {
  94             pCred = cStub.acquireCred(0, password, store, lifetime, usage);
  95             this.name = new GSSNameElement(cStub.getCredName(pCred), cStub.getMech(), cStub);
  96             doServicePermCheck();
  97             isDefCred = true;
  98         }
  99     }
 100 
 101     GSSCredElement(GSSNameElement name, Map&lt;String,String&gt; store, int lifetime,
 102                    int usage, GSSLibStub stub) throws GSSException {
 103         this(name, (String)null, store, lifetime, usage, stub);
 104     }
 105 
 106     GSSCredElement(GSSNameElement name, String password, int lifetime,
 107                    int usage, GSSLibStub stub) throws GSSException {
 108         this(name, password, (Map&lt;String,String&gt;)null, lifetime, usage, stub);
 109     }
 110 
 111     GSSCredElement(GSSNameElement name, int lifetime, int usage,
 112                    GSSLibStub stub) throws GSSException {
 113         this(name, (String)null, lifetime, usage, stub);
 114     }
 115 
 116     public void storeInto(int usage, boolean overwrite, boolean defaultCred,
 117                           Map&lt;String,String&gt; store)
 118             throws GSSException {
 119         cStub.storeCred(pCred, usage, getMechanism(), overwrite,
 120                         defaultCred, store);
 121     }
 122 
 123     public Provider getProvider() {
 124         return SunNativeProvider.INSTANCE;
 125     }
 126 
 127     public void dispose() throws GSSException {
 128         name = null;
 129         if (pCred != 0) {
 130             pCred = cStub.releaseCred(pCred);
 131         }
 132     }
 133 
 134     public GSSNameElement getName() throws GSSException {
 135         return (name == GSSNameElement.DEF_ACCEPTOR ?
 136             null : name);
 137     }
 138 
 139     public int getInitLifetime() throws GSSException {
 140         if (isInitiatorCredential()) {
 141             return cStub.getCredTime(pCred);
 142         } else return 0;
 143     }
 144 
 145     public int getAcceptLifetime() throws GSSException {
 146         if (isAcceptorCredential()) {
 147             return cStub.getCredTime(pCred);
 148         } else return 0;
 149     }
 150 
 151     public boolean isInitiatorCredential() {
 152         return (usage != GSSCredential.ACCEPT_ONLY);
 153     }
 154 
 155     public boolean isAcceptorCredential() {
 156         return (usage != GSSCredential.INITIATE_ONLY);
 157     }
 158 
 159     public Oid getMechanism() {
 160         return cStub.getMech();
 161     }
 162 
 163     public boolean isDefaultCredential() {
 164         return isDefCred;
 165     }
 166 
 167     public String toString() {
 168         // No hex bytes available for native impl
 169         return "N/A";
 170     }
 171 
 172     @SuppressWarnings("deprecation")
 173     protected void finalize() throws Throwable {
 174         dispose();
 175     }
 176 
 177     @Override
 178     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
 179         throw new GSSException(GSSException.FAILURE, -1,
 180                 "Not supported yet");
 181     }
 182 }
</pre></body></html>
