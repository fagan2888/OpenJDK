<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre>Add JGSS JNI bindings for gss cred store functions
Add createCredential() with password
Also avoid memory allocation in newGSSOIDSet() renamed to makeGSSOIDset()
which now takes a singleton set argument and either assigns the requested
OID or with SPNEGO returns a static list of all the supported mechs. With
this we no longer need deleteGSSOIDSet().</pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 2005, 2011, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the "Classpath" exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.jgss.wrapper;
  27 
  28 import java.io.UnsupportedEncodingException;
  29 import java.security.Provider;
<a name="1" id="anc1"></a>
  30 import java.util.Vector;
  31 import org.ietf.jgss.*;
  32 import sun.security.jgss.GSSUtil;
  33 import sun.security.jgss.GSSCaller;
  34 import sun.security.jgss.GSSExceptionImpl;
  35 import sun.security.jgss.spi.*;
  36 
  37 /**
  38  * JGSS plugin for generic mechanisms provided through native GSS framework.
  39  *
  40  * @author Valerie Peng
  41  */
  42 
  43 public final class NativeGSSFactory implements MechanismFactory {
  44 
  45     GSSLibStub cStub = null;
  46     private final GSSCaller caller;
  47 
  48     private GSSCredElement getCredFromSubject(GSSNameElement name,
  49                                               boolean initiate)
  50         throws GSSException {
  51         Oid mech = cStub.getMech();
  52         Vector&lt;GSSCredElement&gt; creds = GSSUtil.searchSubject
  53             (name, mech, initiate, GSSCredElement.class);
  54 
  55         // If Subject is present but no native creds available
  56         if (creds != null &amp;&amp; creds.isEmpty()) {
  57             if (GSSUtil.useSubjectCredsOnly(caller)) {
  58                 throw new GSSException(GSSException.NO_CRED);
  59             }
  60         }
  61 
  62         GSSCredElement result = ((creds == null || creds.isEmpty()) ?
  63                                  null : creds.firstElement());
  64         // Force permission check before returning the cred to caller
  65         if (result != null) {
  66             result.doServicePermCheck();
  67         }
  68         return result;
  69     }
  70 
  71     public NativeGSSFactory(GSSCaller caller) {
  72         this.caller = caller;
  73         // Have to call setMech(Oid) explicitly before calling other
  74         // methods. Otherwise, NPE may be thrown unexpectantly
  75     }
  76 
  77     public void setMech(Oid mech) throws GSSException {
  78         cStub = GSSLibStub.getInstance(mech);
  79     }
  80 
  81     public GSSNameSpi getNameElement(String nameStr, Oid nameType)
  82         throws GSSException {
  83         try {
  84             byte[] nameBytes =
  85                 (nameStr == null ? null : nameStr.getBytes("UTF-8"));
  86             return new GSSNameElement(nameBytes, nameType, cStub);
  87         } catch (UnsupportedEncodingException uee) {
  88             // Shouldn't happen
  89             throw new GSSExceptionImpl(GSSException.FAILURE, uee);
  90         }
  91     }
  92 
  93     public GSSNameSpi getNameElement(byte[] name, Oid nameType)
  94         throws GSSException {
  95         return new GSSNameElement(name, nameType, cStub);
  96     }
  97 
  98     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,
<a name="2" id="anc2"></a>
  99                                                  int initLifetime,
 100                                                  int acceptLifetime,
 101                                                  int usage)
 102         throws GSSException {
 103         GSSNameElement nname = null;
 104         if (name != null &amp;&amp; !(name instanceof GSSNameElement)) {
 105             nname = (GSSNameElement)
 106                 getNameElement(name.toString(), name.getStringNameType());
 107         } else nname = (GSSNameElement) name;
 108 
 109         if (usage == GSSCredential.INITIATE_AND_ACCEPT) {
 110             // Force separate acqusition of cred element since
 111             // MIT's impl does not correctly report NO_CRED error.
 112             usage = GSSCredential.INITIATE_ONLY;
 113         }
 114 
 115         GSSCredElement credElement =
 116             getCredFromSubject(nname, (usage == GSSCredential.INITIATE_ONLY));
 117 
 118         if (credElement == null) {
 119             // No cred in the Subject
 120             if (usage == GSSCredential.INITIATE_ONLY) {
<a name="3" id="anc3"></a>
 121                 credElement = new GSSCredElement(nname, initLifetime,
 122                                                  usage, cStub);
<a name="4" id="anc4"></a>
























































 123             } else if (usage == GSSCredential.ACCEPT_ONLY) {
 124                 if (nname == null) {
 125                     nname = GSSNameElement.DEF_ACCEPTOR;
 126                 }
<a name="5" id="anc5"></a>
 127                 credElement = new GSSCredElement(nname, acceptLifetime,
 128                                                  usage, cStub);
 129             } else {
<a name="6" id="anc6"></a>




 130                 throw new GSSException(GSSException.FAILURE, -1,
 131                                        "Unknown usage mode requested");
 132             }
 133         }
 134         return credElement;
<a name="7" id="anc7"></a>








 135     }
 136 
 137     public GSSContextSpi getMechanismContext(GSSNameSpi peer,
 138                                              GSSCredentialSpi myCred,
 139                                              int lifetime)
 140         throws GSSException {
 141         if (peer == null) {
 142             throw new GSSException(GSSException.BAD_NAME);
 143         } else if (!(peer instanceof GSSNameElement)) {
 144             peer = (GSSNameElement)
 145                 getNameElement(peer.toString(), peer.getStringNameType());
 146         }
 147         if (myCred == null) {
 148             myCred = getCredFromSubject(null, true);
 149         } else if (!(myCred instanceof GSSCredElement)) {
 150             throw new GSSException(GSSException.NO_CRED);
 151         }
 152         return new NativeGSSContext((GSSNameElement) peer,
 153                                      (GSSCredElement) myCred,
 154                                      lifetime, cStub);
 155     }
 156 
 157     public GSSContextSpi getMechanismContext(GSSCredentialSpi myCred)
 158         throws GSSException {
 159         if (myCred == null) {
 160             myCred = getCredFromSubject(null, false);
 161         } else if (!(myCred instanceof GSSCredElement)) {
 162             throw new GSSException(GSSException.NO_CRED);
 163         }
 164         return new NativeGSSContext((GSSCredElement) myCred, cStub);
 165     }
 166 
 167     public GSSContextSpi getMechanismContext(byte[] exportedContext)
 168         throws GSSException {
 169         return cStub.importContext(exportedContext);
 170     }
 171 
 172     public final Oid getMechanismOid() {
 173         return cStub.getMech();
 174     }
 175 
 176     public Provider getProvider() {
 177         return SunNativeProvider.INSTANCE;
 178     }
 179 
 180     public Oid[] getNameTypes() throws GSSException {
 181         return cStub.inquireNamesForMech();
 182     }
 183 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="8" type="hidden"></input></form></body></html>
