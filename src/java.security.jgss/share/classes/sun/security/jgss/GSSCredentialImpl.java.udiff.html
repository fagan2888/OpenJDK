<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Udiff src/java.security.jgss/share/classes/sun/security/jgss/GSSCredentialImpl.java</title>

<style type="text/css" media="screen">
span.new {
    color: blue;
    font-weight: normal;
}
</style>

</head>
<body id="SUNWwebrev">
        <a class="print" href="javascript:print()">Print this page</a>
<pre>Add JGSS JNI bindings for gss cred store functions
Add createCredential() with password
Also avoid memory allocation in newGSSOIDSet() renamed to makeGSSOIDset()
which now takes a singleton set argument and either assigns the requested
OID or with SPNEGO returns a static list of all the supported mechs. With
this we no longer need deleteGSSOIDSet().</pre>
        <pre>
</pre><hr></hr><pre>
<span class="newmarker">@@ -69,26 +69,79 @@</span>
                              int lifetime, Oid mech, int usage)
         throws GSSException {
         if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;
 
         init(gssManager);
<span class="removed">-        add(name, lifetime, lifetime, mech, usage);</span>
<span class="new">+        String password = null;</span>
<span class="new">+        add(name, password, lifetime, lifetime, mech, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,</span>
<span class="new">+                      Map&lt;String,String&gt; store, int lifetime, Oid mech,</span>
<span class="new">+                      int usage)</span>
<span class="new">+        throws GSSException {</span>
<span class="new">+        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>
<span class="new">+</span>
<span class="new">+        init(gssManager);</span>
<span class="new">+        add(name, store, lifetime, lifetime, mech, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name, String password,</span>
<span class="new">+                      int lifetime, Oid mech, int usage)</span>
<span class="new">+        throws GSSException {</span>
<span class="new">+        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>
<span class="new">+</span>
<span class="new">+        init(gssManager);</span>
<span class="new">+        add(name, password, lifetime, lifetime, mech, usage);</span>
     }
 
     GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,
                       int lifetime, Oid[] mechs, int usage)
         throws GSSException {
<span class="new">+        this(gssManager, name, (String)null, lifetime, mechs, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,</span>
<span class="new">+                      Map&lt;String,String&gt; store, int lifetime,</span>
<span class="new">+                      Oid mechs[], int usage)</span>
<span class="new">+        throws GSSException {</span>
         init(gssManager);
         boolean defaultList = false;
         if (mechs == null) {
             mechs = gssManager.getMechs();
             defaultList = true;
         }
 
         for (int i = 0; i &lt; mechs.length; i++) {
             try {
<span class="removed">-                add(name, lifetime, lifetime, mechs[i], usage);</span>
<span class="new">+                add(name, store, lifetime, lifetime, mechs[i], usage);</span>
<span class="new">+            } catch (GSSException e) {</span>
<span class="new">+                if (defaultList) {</span>
<span class="new">+                    // Try the next mechanism</span>
<span class="new">+                    GSSUtil.debug("Ignore " + e + " while acquring cred for "</span>
<span class="new">+                        + mechs[i]);</span>
<span class="new">+                    //e.printStackTrace();</span>
<span class="new">+                } else throw e; // else try the next mechanism</span>
<span class="new">+            }</span>
<span class="new">+        }</span>
<span class="new">+        if ((hashtable.size() == 0) || (usage != getUsage()))</span>
<span class="new">+            throw new GSSException(GSSException.NO_CRED);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,</span>
<span class="new">+                      String password, int lifetime, Oid mechs[], int usage)</span>
<span class="new">+        throws GSSException {</span>
<span class="new">+        init(gssManager);</span>
<span class="new">+        boolean defaultList = false;</span>
<span class="new">+        if (mechs == null) {</span>
<span class="new">+            mechs = gssManager.getMechs();</span>
<span class="new">+            defaultList = true;</span>
<span class="new">+        }</span>
<span class="new">+</span>
<span class="new">+        for (int i = 0; i &lt; mechs.length; i++) {</span>
<span class="new">+            try {</span>
<span class="new">+                add(name, password, lifetime, lifetime, mechs[i], usage);</span>
             } catch (GSSException e) {
                 if (defaultList) {
                     // Try the next mechanism
                     GSSUtil.debug("Ignore " + e + " while acquring cred for "
                         + mechs[i]);
</pre><hr></hr><pre>
<span class="newmarker">@@ -415,10 +468,31 @@</span>
         return result.toArray(new Oid[0]);
     }
 
     public void add(GSSName name, int initLifetime, int acceptLifetime,
                     Oid mech, int usage) throws GSSException {
<span class="new">+        String password = null;</span>
<span class="new">+        add(name, password, initLifetime, acceptLifetime, mech, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    public void add(GSSName name, Map&lt;String,String&gt; store, int initLifetime,</span>
<span class="new">+                    int acceptLifetime, Oid mech, int usage)</span>
<span class="new">+                    throws GSSException {</span>
<span class="new">+        add(name, (String)null, store, initLifetime, acceptLifetime,</span>
<span class="new">+            mech, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    public void add(GSSName name, String password, int initLifetime,</span>
<span class="new">+                    int acceptLifetime, Oid mech, int usage)</span>
<span class="new">+                    throws GSSException {</span>
<span class="new">+        add(name, password, (Map&lt;String,String&gt;)null, initLifetime,</span>
<span class="new">+            acceptLifetime, mech, usage);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    private void add(GSSName name, String password, Map&lt;String,String&gt; store,</span>
<span class="new">+                    int initLifetime, int acceptLifetime, Oid mech, int usage)</span>
<span class="new">+                    throws GSSException {</span>
 
         if (destroyed) {
             throw new IllegalStateException("This credential is " +
                                         "no longer valid");
         }
</pre><hr></hr><pre>
<span class="newmarker">@@ -434,15 +508,31 @@</span>
         // XXX If not instance of GSSNameImpl then throw exception
         // Application mixing GSS implementations
         GSSNameSpi nameElement = (name == null ? null :
                                   ((GSSNameImpl)name).getElement(mech));
 
<span class="new">+        if (password == null &amp;&amp; store == null) {</span>
<span class="new">+            tempCred = gssManager.getCredentialElement(nameElement,</span>
<span class="new">+                                                       initLifetime,</span>
<span class="new">+                                                       acceptLifetime,</span>
<span class="new">+                                                       mech,</span>
<span class="new">+                                                       usage);</span>
<span class="new">+        } else if (password != null) {</span>
         tempCred = gssManager.getCredentialElement(nameElement,
<span class="new">+                                                       password,</span>
                                                    initLifetime,
                                                    acceptLifetime,
                                                    mech,
                                                    usage);
<span class="new">+        } else {</span>
<span class="new">+            tempCred = gssManager.getCredentialElement(nameElement,</span>
<span class="new">+                                                       store,</span>
<span class="new">+                                                       initLifetime,</span>
<span class="new">+                                                       acceptLifetime,</span>
<span class="new">+                                                       mech,</span>
<span class="new">+                                                       usage);</span>
<span class="new">+        }</span>
         /*
          * Not all mechanisms support the concept of one credential element
          * that can be used for both initiating and accepting a context. In
          * the event that an application requests usage INITIATE_AND_ACCEPT
          * for a credential from such a mechanism, the GSS framework will
</pre><hr></hr><pre>
<span class="newmarker">@@ -472,15 +562,31 @@</span>
                 }
 
                 key = new SearchKey(mech, currentUsage);
                 hashtable.put(key, tempCred);
 
<span class="new">+                if (store == null &amp;&amp; password == null) {</span>
<span class="new">+                    tempCred = gssManager.getCredentialElement(nameElement,</span>
<span class="new">+                                                               initLifetime,</span>
<span class="new">+                                                               acceptLifetime,</span>
<span class="new">+                                                               mech,</span>
<span class="new">+                                                               desiredUsage);</span>
<span class="new">+                } else if (password != null) {</span>
<span class="new">+                    tempCred = gssManager.getCredentialElement(nameElement,</span>
<span class="new">+                                                               password,</span>
<span class="new">+                                                               initLifetime,</span>
<span class="new">+                                                               acceptLifetime,</span>
<span class="new">+                                                               mech,</span>
<span class="new">+                                                               desiredUsage);</span>
<span class="new">+                } else {</span>
                 tempCred = gssManager.getCredentialElement(nameElement,
<span class="new">+                                                               store,</span>
                                                         initLifetime,
                                                         acceptLifetime,
                                                         mech,
                                                         desiredUsage);
<span class="new">+                }</span>
 
                 key = new SearchKey(mech, desiredUsage);
                 hashtable.put(key, tempCred);
             } else {
                 hashtable.put(key, tempCred);
</pre><hr></hr><pre>
<span class="newmarker">@@ -638,10 +744,35 @@</span>
                 displayString.concat(" usage: Initiate and Accept");
         }
         return displayString;
     }
 
<span class="new">+    public void storeInto(int usage, Oid mech,</span>
<span class="new">+                          boolean overwrite, boolean defaultCred,</span>
<span class="new">+                          Map&lt;String,String&gt; store) throws GSSException {</span>
<span class="new">+        if (destroyed) {</span>
<span class="new">+            throw new IllegalStateException("This credential is " +</span>
<span class="new">+                                            "no longer valid");</span>
<span class="new">+        }</span>
<span class="new">+</span>
<span class="new">+        SearchKey key = null;</span>
<span class="new">+        GSSCredentialSpi element = null;</span>
<span class="new">+</span>
<span class="new">+        if (mech == null) {</span>
<span class="new">+            mech = ProviderList.DEFAULT_MECH_OID;</span>
<span class="new">+        }</span>
<span class="new">+</span>
<span class="new">+        key = new SearchKey(mech, usage);</span>
<span class="new">+        element = hashtable.get(key);</span>
<span class="new">+        if (element == null) {</span>
<span class="new">+            throw new GSSExceptionImpl(GSSException.BAD_MECH, mech);</span>
<span class="new">+        }</span>
<span class="new">+</span>
<span class="new">+        element.storeInto(usage, overwrite, defaultCred, store);</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+</span>
     public String toString() {
 
         if (destroyed) {
             throw new IllegalStateException("This credential is " +
                                         "no longer valid");
</pre></body></html>

