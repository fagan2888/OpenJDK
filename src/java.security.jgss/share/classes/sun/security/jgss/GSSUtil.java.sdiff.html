<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache"></meta>
<meta http-equiv="Content-Type" content="text/xhtml;charset=utf-8"></meta>
<meta http-equiv="Pragma" content="no-cache"></meta>
<meta http-equiv="Expires" content="-1"></meta>
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
span.chmod {
    font-size: 0.7em;
    color: #db7800;
}
a.print { font-size: x-small; }
a:hover { background-color: #ffcc99; }
</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>ws Sdiff src/java.security.jgss/share/classes/sun/security/jgss/GSSUtil.java</title>
</head><body id="SUNWwebrev">
<a class="print" href="javascript:print()">Print this page</a>
<pre>Modernize GSSUtil.java
Based on code review commentary by Peter Burka.
Make GSSName implement Principal (add getName())
JGSS: Prefer default cred handles if possible</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
 103 
 104     public static String getMechStr(Oid oid) {
 105         if (isSpNegoMech(oid)) {
 106             return "SPNEGO";
 107         } else if (isKerberosMech(oid)) {
 108             return "Kerberos V5";
 109         } else {
 110             return oid.toString();
 111         }
 112     }
 113 
 114     /**
 115      * Note: The current impl only works with Sun's impl of
 116      * GSSName and GSSCredential since it depends on package
 117      * private APIs.
 118      */
 119     public static Subject getSubject(GSSName name,
 120                                      GSSCredential creds) {
 121 
 122         HashSet&lt;Object&gt; privCredentials = null;
<span class="changed"> 123         HashSet&lt;Object&gt; pubCredentials = new HashSet&lt;Object&gt;(); // empty Set</span>
 124 
 125         Set&lt;GSSCredentialSpi&gt; gssCredentials = null;
 126 
<span class="changed"> 127         Set&lt;KerberosPrincipal&gt; krb5Principals =</span>
<span class="changed"> 128                                 new HashSet&lt;KerberosPrincipal&gt;();</span>
<span class="changed"> 129 </span>
<span class="changed"> 130         if (name instanceof GSSNameImpl) {</span>
<span class="changed"> 131             try {</span>
<span class="changed"> 132                 GSSNameSpi ne = ((GSSNameImpl) name).getElement</span>
<span class="changed"> 133                     (GSS_KRB5_MECH_OID);</span>
<span class="changed"> 134                 String krbName = ne.toString();</span>
<span class="changed"> 135                 if (ne instanceof Krb5NameElement) {</span>
<span class="changed"> 136                     krbName =</span>
<span class="changed"> 137                         ((Krb5NameElement) ne).getKrb5PrincipalName().getName();</span>
<span class="changed"> 138                 }</span>
<span class="changed"> 139                 KerberosPrincipal krbPrinc = new KerberosPrincipal(krbName);</span>
<span class="changed"> 140                 krb5Principals.add(krbPrinc);</span>
<span class="changed"> 141             } catch (GSSException ge) {</span>
<span class="changed"> 142                 debug("Skipped name " + name + " due to " + ge);</span>
<span class="changed"> 143             }</span>
<span class="changed"> 144         }</span>
 145 
 146         if (creds instanceof GSSCredentialImpl) {
 147             gssCredentials = ((GSSCredentialImpl) creds).getElements();
<span class="changed"> 148             privCredentials = new HashSet&lt;Object&gt;(gssCredentials.size());</span>
 149             populateCredentials(privCredentials, gssCredentials);
 150         } else {
<span class="changed"> 151             privCredentials = new HashSet&lt;Object&gt;(); // empty Set</span>
 152         }
 153         debug("Created Subject with the following");
<span class="changed"> 154         debug("principals=" + krb5Principals);</span>
 155         debug("public creds=" + pubCredentials);
 156         debug("private creds=" + privCredentials);
 157 
<span class="changed"> 158         return new Subject(false, krb5Principals, pubCredentials,</span>
<span class="changed"> 159                            privCredentials);</span>
 160 
 161     }
 162 
 163     /**
 164      * Populates the set credentials with elements from gssCredentials. At
 165      * the same time, it converts any subclasses of KerberosTicket
 166      * into KerberosTicket instances and any subclasses of KerberosKey into
 167      * KerberosKey instances. (It is not desirable to expose the customer
 168      * to sun.security.jgss.krb5.Krb5InitCredential which extends
 169      * KerberosTicket and sun.security.jgss.krb5.Kbr5AcceptCredential which
 170      * extends KerberosKey.)
 171      */
 172     private static void populateCredentials(Set&lt;Object&gt; credentials,
 173                                             Set&lt;?&gt; gssCredentials) {
 174 
<span class="changed"> 175         Object cred;</span>
<span class="changed"> 176 </span>
<span class="changed"> 177         Iterator&lt;?&gt; elements = gssCredentials.iterator();</span>
<span class="changed"> 178         while (elements.hasNext()) {</span>
<span class="changed"> 179 </span>
<span class="changed"> 180             cred = elements.next();</span>
 181 
 182             // Retrieve the internal cred out of SpNegoCredElement
 183             if (cred instanceof SpNegoCredElement) {
 184                 cred = ((SpNegoCredElement) cred).getInternalCred();
 185             }
 186 
 187             if (cred instanceof KerberosTicket) {
 188                 if (!cred.getClass().getName().equals
 189                     ("javax.security.auth.kerberos.KerberosTicket")) {
 190                     KerberosTicket tempTkt = (KerberosTicket) cred;
 191                     cred = new KerberosTicket(tempTkt.getEncoded(),
 192                                               tempTkt.getClient(),
 193                                               tempTkt.getServer(),
 194                                               tempTkt.getSessionKey().getEncoded(),
 195                                               tempTkt.getSessionKeyType(),
 196                                               tempTkt.getFlags(),
 197                                               tempTkt.getAuthTime(),
 198                                               tempTkt.getStartTime(),
 199                                               tempTkt.getEndTime(),
 200                                               tempTkt.getRenewTill(),

</pre><hr></hr><pre>
 304      * no Subject present or a Vector which contains 0 or more
 305      * matching GSSCredentialSpi objects.
 306      */
 307     public static &lt;T extends GSSCredentialSpi&gt; Vector&lt;T&gt;
 308             searchSubject(final GSSNameSpi name,
 309                           final Oid mech,
 310                           final boolean initiate,
 311                           final Class&lt;? extends T&gt; credCls) {
 312         debug("Search Subject for " + getMechStr(mech) +
 313               (initiate? " INIT" : " ACCEPT") + " cred (" +
 314               (name == null? "&lt;&lt;DEF&gt;&gt;" : name.toString()) + ", " +
 315               credCls.getName() + ")");
 316         final AccessControlContext acc = AccessController.getContext();
 317         try {
 318             Vector&lt;T&gt; creds =
 319                 AccessController.doPrivileged
 320                 (new PrivilegedExceptionAction&lt;Vector&lt;T&gt;&gt;() {
 321                     public Vector&lt;T&gt; run() throws Exception {
 322                         Subject accSubj = Subject.getSubject(acc);
 323                         Vector&lt;T&gt; result = null;
<span class="changed"> 324                         if (accSubj != null) {</span>




 325                             result = new Vector&lt;T&gt;();
<span class="changed"> 326                             Iterator&lt;GSSCredentialImpl&gt; iterator =</span>
<span class="changed"> 327                                 accSubj.getPrivateCredentials</span>
<span class="changed"> 328                                 (GSSCredentialImpl.class).iterator();</span>
<span class="changed"> 329                             while (iterator.hasNext()) {</span>
<span class="changed"> 330                                 GSSCredentialImpl cred = iterator.next();</span>
 331                                 debug("...Found cred" + cred);
 332                                 try {
 333                                     GSSCredentialSpi ce =
 334                                         cred.getElement(mech, initiate);
 335                                     debug("......Found element: " + ce);
<span class="changed"> 336                                     if (ce.getClass().equals(credCls) &amp;&amp;</span>
<span class="changed"> 337                                         (name == null ||</span>
<span class="changed"> 338                                          name.equals((Object) ce.getName()))) {</span>











 339                                         result.add(credCls.cast(ce));
 340                                     } else {
<span class="changed"> 341                                         debug("......Discard element");</span>
 342                                     }
 343                                 } catch (GSSException ge) {
<span class="changed"> 344                                     debug("...Discard cred (" + ge + ")");</span>
 345                                 }
 346                             }
<span class="removed"> 347                         } else debug("No Subject");</span>
 348                         return result;
 349                     }
 350                 });
 351             return creds;
 352         } catch (PrivilegedActionException pae) {
 353             debug("Unexpected exception when searching Subject:");
 354             if (DEBUG) pae.printStackTrace();
 355             return null;
 356         }
 357     }
 358 }
</pre></td><td><pre>

</pre><hr></hr><pre>
 103 
 104     public static String getMechStr(Oid oid) {
 105         if (isSpNegoMech(oid)) {
 106             return "SPNEGO";
 107         } else if (isKerberosMech(oid)) {
 108             return "Kerberos V5";
 109         } else {
 110             return oid.toString();
 111         }
 112     }
 113 
 114     /**
 115      * Note: The current impl only works with Sun's impl of
 116      * GSSName and GSSCredential since it depends on package
 117      * private APIs.
 118      */
 119     public static Subject getSubject(GSSName name,
 120                                      GSSCredential creds) {
 121 
 122         HashSet&lt;Object&gt; privCredentials = null;
<span class="changed"> 123         HashSet&lt;Object&gt; pubCredentials = new HashSet&lt;&gt;(); // empty Set</span>
 124 
 125         Set&lt;GSSCredentialSpi&gt; gssCredentials = null;
 126 
<span class="changed"> 127         Set&lt;GSSName&gt; names = new HashSet&lt;&gt;();</span>
<span class="changed"> 128         names.add(name);</span>
















 129 
 130         if (creds instanceof GSSCredentialImpl) {
 131             gssCredentials = ((GSSCredentialImpl) creds).getElements();
<span class="changed"> 132             privCredentials = new HashSet&lt;&gt;(gssCredentials.size());</span>
 133             populateCredentials(privCredentials, gssCredentials);
 134         } else {
<span class="changed"> 135             privCredentials = new HashSet&lt;&gt;(); // empty Set</span>
 136         }
 137         debug("Created Subject with the following");
<span class="changed"> 138         debug("principals=" + names);</span>
 139         debug("public creds=" + pubCredentials);
 140         debug("private creds=" + privCredentials);
 141 
<span class="changed"> 142         return new Subject(false, names, pubCredentials, privCredentials);</span>

 143 
 144     }
 145 
 146     /**
 147      * Populates the set credentials with elements from gssCredentials. At
 148      * the same time, it converts any subclasses of KerberosTicket
 149      * into KerberosTicket instances and any subclasses of KerberosKey into
 150      * KerberosKey instances. (It is not desirable to expose the customer
 151      * to sun.security.jgss.krb5.Krb5InitCredential which extends
 152      * KerberosTicket and sun.security.jgss.krb5.Kbr5AcceptCredential which
 153      * extends KerberosKey.)
 154      */
 155     private static void populateCredentials(Set&lt;Object&gt; credentials,
 156                                             Set&lt;?&gt; gssCredentials) {
 157 
<span class="changed"> 158         for (Object cred : gssCredentials) {</span>





 159 
 160             // Retrieve the internal cred out of SpNegoCredElement
 161             if (cred instanceof SpNegoCredElement) {
 162                 cred = ((SpNegoCredElement) cred).getInternalCred();
 163             }
 164 
 165             if (cred instanceof KerberosTicket) {
 166                 if (!cred.getClass().getName().equals
 167                     ("javax.security.auth.kerberos.KerberosTicket")) {
 168                     KerberosTicket tempTkt = (KerberosTicket) cred;
 169                     cred = new KerberosTicket(tempTkt.getEncoded(),
 170                                               tempTkt.getClient(),
 171                                               tempTkt.getServer(),
 172                                               tempTkt.getSessionKey().getEncoded(),
 173                                               tempTkt.getSessionKeyType(),
 174                                               tempTkt.getFlags(),
 175                                               tempTkt.getAuthTime(),
 176                                               tempTkt.getStartTime(),
 177                                               tempTkt.getEndTime(),
 178                                               tempTkt.getRenewTill(),

</pre><hr></hr><pre>
 282      * no Subject present or a Vector which contains 0 or more
 283      * matching GSSCredentialSpi objects.
 284      */
 285     public static &lt;T extends GSSCredentialSpi&gt; Vector&lt;T&gt;
 286             searchSubject(final GSSNameSpi name,
 287                           final Oid mech,
 288                           final boolean initiate,
 289                           final Class&lt;? extends T&gt; credCls) {
 290         debug("Search Subject for " + getMechStr(mech) +
 291               (initiate? " INIT" : " ACCEPT") + " cred (" +
 292               (name == null? "&lt;&lt;DEF&gt;&gt;" : name.toString()) + ", " +
 293               credCls.getName() + ")");
 294         final AccessControlContext acc = AccessController.getContext();
 295         try {
 296             Vector&lt;T&gt; creds =
 297                 AccessController.doPrivileged
 298                 (new PrivilegedExceptionAction&lt;Vector&lt;T&gt;&gt;() {
 299                     public Vector&lt;T&gt; run() throws Exception {
 300                         Subject accSubj = Subject.getSubject(acc);
 301                         Vector&lt;T&gt; result = null;
<span class="changed"> 302                         if (accSubj == null) {</span>
<span class="changed"> 303                             debug("No Subject");</span>
<span class="changed"> 304                             return result;</span>
<span class="changed"> 305                         }</span>
<span class="changed"> 306 </span>
 307                         result = new Vector&lt;T&gt;();
<span class="changed"> 308                         for (GSSCredentialImpl cred : accSubj.getPrivateCredentials</span>
<span class="changed"> 309                                                       (GSSCredentialImpl.class)) {</span>



 310                             debug("...Found cred" + cred);
 311                             try {
 312                                 GSSCredentialSpi ce =
 313                                     cred.getElement(mech, initiate);
 314                                 debug("......Found element: " + ce);
<span class="changed"> 315                                 if (!ce.getClass().equals(credCls)) {</span>
<span class="changed"> 316                                     debug("......Discard element (class mismatch)");</span>
<span class="changed"> 317                                 } else if (name == null) {</span>
<span class="changed"> 318                                     /*</span>
<span class="changed"> 319                                      * If the caller doesn't care about</span>
<span class="changed"> 320                                      * the specific name, then prefer</span>
<span class="changed"> 321                                      * default credentials to</span>
<span class="changed"> 322                                      * non-default credentials.</span>
<span class="changed"> 323                                      */</span>
<span class="changed"> 324                                     if (ce.isDefaultCredential())</span>
<span class="changed"> 325                                         result.add(0, credCls.cast(ce));</span>
<span class="changed"> 326                                     else</span>
<span class="changed"> 327                                         result.add(credCls.cast(ce));</span>
<span class="changed"> 328                                 } else if (name.equals((Object) ce.getName())) {</span>
 329                                     result.add(credCls.cast(ce));
 330                                 } else {
<span class="changed"> 331                                     debug("......Discard element (name mismatch)");</span>
 332                                 }
 333                             } catch (GSSException ge) {
<span class="changed"> 334                                 debug("...Discard cred (exception: " + ge + ")");</span>
 335                             }
 336                         }

 337                         return result;
 338                     }
 339                 });
 340             return creds;
 341         } catch (PrivilegedActionException pae) {
 342             debug("Unexpected exception when searching Subject:");
 343             if (DEBUG) pae.printStackTrace();
 344             return null;
 345         }
 346     }
 347 }
</pre></td>
</tr></table>
</body></html>
